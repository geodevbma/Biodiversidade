{% extends "base.html" %}

{% block title %}Colaboradores de campo - Biodiversidade{% endblock %}

{% block header_title %}
Colaboradores de campo
{% endblock %}

{% block header_subtitle %}
<p class="text-[12px] text-slate-400">
  Gestao da equipe que utiliza o aplicativo em campo.
</p>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.tailwindcss.css" />
<style>
  .hero-colab {
    background:
      radial-gradient(1200px 280px at 10% 0%, rgba(16, 185, 129, 0.16), transparent 60%),
      radial-gradient(1000px 300px at 95% 15%, rgba(14, 116, 144, 0.14), transparent 58%),
      rgba(var(--surface-950-rgb), 0.84);
  }
  .card-shell {
    border: 1px solid rgba(var(--surface-700-rgb), 0.85);
    background: linear-gradient(145deg, rgba(var(--surface-900-rgb), 0.9), rgba(var(--surface-950-rgb), 0.9));
    box-shadow: inset 0 0 0 1px rgba(var(--surface-800-rgb), 0.35);
  }
  .table-shell thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    backdrop-filter: blur(8px);
  }
  .dt-container {
    color: rgb(var(--text-300-rgb));
  }
  .dt-container .dt-length label,
  .dt-container .dt-search label {
    color: rgb(var(--text-400-rgb));
    font-size: 11px;
  }
  .dt-container .dt-input,
  .dt-container select.dt-input {
    background: rgba(var(--surface-900-rgb), 0.88) !important;
    border: 1px solid rgba(var(--surface-700-rgb), 0.9) !important;
    color: rgb(var(--text-200-rgb)) !important;
    border-radius: 0.55rem;
  }
  .dt-container .dt-paging .dt-paging-button {
    border: 1px solid rgba(var(--surface-700-rgb), 0.9) !important;
    background: rgba(var(--surface-900-rgb), 0.82) !important;
    color: rgb(var(--text-300-rgb)) !important;
    border-radius: 0.5rem;
    margin: 0 2px;
  }
  .dt-container .dt-paging .dt-paging-button.current,
  .dt-container .dt-paging .dt-paging-button.current:hover {
    border-color: rgba(16, 185, 129, 0.55) !important;
    background: rgba(16, 185, 129, 0.14) !important;
    color: #86efac !important;
  }
  .dt-container .dt-info {
    color: rgb(var(--text-400-rgb));
    font-size: 11px;
  }
  .dt-container .dt-layout-row:last-child {
    display: flex !important;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .dt-container .dt-paging {
    display: flex !important;
    align-items: center;
  }
</style>
{% endblock %}

{% block content %}
<div class="space-y-5 pb-10 animate-fadeUp">
  <section class="hero-colab rounded-3xl border border-slate-800/80 p-4 md:p-6">
    <div class="grid grid-cols-1 lg:grid-cols-[1.25fr_1fr] gap-4 lg:items-end">
      <div class="space-y-3">
        <span class="inline-flex items-center gap-2 rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.18em] text-emerald-300">
          Controle da equipe
        </span>
        <div>
          <h1 class="text-lg md:text-2xl font-semibold text-slate-100">Gestao de colaboradores</h1>
          <p class="mt-1 text-[12px] md:text-[13px] text-slate-300/90 max-w-2xl">
            Cadastre, filtre e atualize rapidamente os colaboradores ativos em campo.
          </p>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <div class="card-shell rounded-xl p-3">
          <p class="text-[10px] uppercase tracking-wider text-slate-400">Total</p>
          <p id="statTotal" class="mt-1 text-xl font-semibold text-slate-100">-</p>
        </div>
        <div class="card-shell rounded-xl p-3">
          <p class="text-[10px] uppercase tracking-wider text-slate-400">Ativos</p>
          <p id="statAtivos" class="mt-1 text-xl font-semibold text-slate-100">-</p>
        </div>
        <div class="card-shell rounded-xl p-3">
          <p class="text-[10px] uppercase tracking-wider text-slate-400">Inativos</p>
          <p id="statInativos" class="mt-1 text-xl font-semibold text-slate-100">-</p>
        </div>
        <div class="card-shell rounded-xl p-3">
          <p class="text-[10px] uppercase tracking-wider text-slate-400">Expirados</p>
          <p id="statExpirados" class="mt-1 text-xl font-semibold text-slate-100">-</p>
        </div>
      </div>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-800/80 bg-slate-950/80 p-4 md:p-5 backdrop-blur-xl">
    <div class="flex items-center gap-2 mb-3">
      <span class="h-1.5 w-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
      <span class="text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400">Filtros e acoes</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3">
      <label class="space-y-1">
        <span class="text-[11px] text-slate-400">Busca</span>
        <input
          id="searchInput"
          type="text"
          placeholder="Nome, email, documento..."
          class="w-full px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700/80 text-sm
                 outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-500/20"
        />
      </label>

      <label class="space-y-1">
        <span class="text-[11px] text-slate-400">Status</span>
        <select
          id="statusFilter"
          class="w-full px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700/80 text-sm
                 outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-500/20"
        >
          <option value="todos">Todos</option>
          <option value="ativos">Somente ativos</option>
          <option value="inativos">Somente inativos</option>
        </select>
      </label>

      <label class="space-y-1">
        <span class="text-[11px] text-slate-400">Validade</span>
        <select
          id="expiraFilter"
          class="w-full px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700/80 text-sm
                 outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-500/20"
        >
          <option value="todos">Todos</option>
          <option value="validos">Vigentes</option>
          <option value="vence">Vencem em ate 30 dias</option>
          <option value="expirados">Expirados</option>
          <option value="sem_data">Sem validade</option>
        </select>
      </label>

      <div class="flex items-end">
        <button
          id="btnNovo"
          class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-emerald-500 text-slate-950 text-sm font-semibold
                 hover:bg-emerald-400 hover:shadow-neon transition-all"
        >
          Novo colaborador
        </button>
      </div>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-800/80 bg-slate-950/85 backdrop-blur-xl overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-800/80 flex items-center justify-between gap-3">
      <p id="countInfo" class="text-xs text-slate-400">Carregando colaboradores...</p>
      <p class="hidden md:block text-[11px] text-slate-500">Apenas administradores podem editar os dados.</p>
    </div>

    <div class="table-shell overflow-x-auto">
      <table id="tableColaboradores" class="min-w-full text-xs md:text-sm">
        <thead class="bg-slate-900/92 border-b border-slate-800/80">
          <tr>
            <th class="px-3 py-2 text-left font-medium text-slate-300">Nome</th>
            <th class="px-3 py-2 text-left font-medium text-slate-300">Contato</th>
            <th class="px-3 py-2 text-left font-medium text-slate-300">Documento</th>
            <th class="px-3 py-2 text-left font-medium text-slate-300">Validade</th>
            <th class="px-3 py-2 text-left font-medium text-slate-300">Status</th>
            <th class="px-3 py-2 text-right font-medium text-slate-300">Acoes</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y divide-slate-800/80">
          <!-- linhas via JS -->
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}

{% block modals %}
<div id="modal" class="absolute inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm">
  <div class="max-w-3xl w-full mx-4 rounded-2xl bg-slate-950/95 border border-slate-800/80 shadow-neon p-5 md:p-6 animate-slideIn relative">
    <button id="modalClose" class="absolute top-3 right-3 text-slate-400 hover:text-slate-100 text-sm">
      X
    </button>

    <h2 id="modalTitle" class="text-lg font-semibold mb-1">Novo colaborador</h2>
    <p class="text-xs text-slate-400 mb-4">
      Preencha os dados do colaborador que ira utilizar o aplicativo em campo.
    </p>

    <form id="modalForm" class="space-y-4">
      <input type="hidden" id="colaboradorId" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="space-y-1">
          <label class="text-xs text-slate-300" for="nome">Nome</label>
          <input
            id="nome"
            type="text"
            required
            class="w-full px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700/80 text-sm
                   outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-500/20"
          />
        </div>

        <div class="space-y-1">
          <label class="text-xs text-slate-300" for="email">E-mail</label>
          <input
            id="email"
            type="email"
            required
            class="w-full px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700/80 text-sm
                   outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-500/20"
          />
        </div>

        <div class="space-y-1">
          <label class="text-xs text-slate-300" for="telefone">Telefone</label>
          <input
            id="telefone"
            type="text"
            class="w-full px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700/80 text-sm
                   outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-500/20"
          />
        </div>

        <div class="space-y-1">
          <label class="text-xs text-slate-300" for="documento">Documento</label>
          <input
            id="documento"
            type="text"
            class="w-full px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700/80 text-sm
                   outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-500/20"
          />
        </div>

        <div class="space-y-1">
          <label class="text-xs text-slate-300" for="expiraEm">Expira em</label>
          <input
            id="expiraEm"
            type="datetime-local"
            class="w-full px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700/80 text-sm
                   outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-500/20"
          />
        </div>

        <div class="space-y-1">
          <label class="text-xs text-slate-300" for="senha">Senha (login no app)</label>
          <input
            id="senha"
            type="password"
            class="w-full px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-700/80 text-sm
                   outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-500/20"
          />
        </div>
      </div>

      <div class="flex items-center justify-between">
        <label class="inline-flex items-center gap-2 text-xs text-slate-200">
          <input id="ativo" type="checkbox" class="rounded border-slate-600 bg-slate-900 text-emerald-500" checked />
          Ativo
        </label>
      </div>

      <p id="modalError" class="hidden text-xs text-rose-400 bg-rose-500/10 border border-rose-500/40 rounded-lg px-3 py-2">
        Ocorreu um erro ao salvar. Verifique os dados e tente novamente.
      </p>

      <div class="flex justify-end gap-2 pt-1">
        <button
          type="button"
          id="btnCancelar"
          class="px-3 py-2 text-xs rounded-lg border border-slate-700/80 text-slate-300 hover:bg-slate-900/80"
        >
          Cancelar
        </button>
        <button
          type="submit"
          id="btnSalvar"
          class="px-4 py-2 text-xs rounded-lg bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400 hover:shadow-neon transition-all"
        >
          Salvar
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.tailwindcss.js"></script>
<script>
  const tableColaboradores = document.getElementById("tableColaboradores");
  const tableBody = document.getElementById("tableBody");
  const countInfo = document.getElementById("countInfo");
  const searchInput = document.getElementById("searchInput");
  const statusFilter = document.getElementById("statusFilter");
  const expiraFilter = document.getElementById("expiraFilter");
  const btnNovo = document.getElementById("btnNovo");

  const statTotal = document.getElementById("statTotal");
  const statAtivos = document.getElementById("statAtivos");
  const statInativos = document.getElementById("statInativos");
  const statExpirados = document.getElementById("statExpirados");

  const modal = document.getElementById("modal");
  const modalClose = document.getElementById("modalClose");
  const btnCancelar = document.getElementById("btnCancelar");
  const modalTitle = document.getElementById("modalTitle");
  const modalForm = document.getElementById("modalForm");
  const modalError = document.getElementById("modalError");

  const colaboradorIdInput = document.getElementById("colaboradorId");
  const nomeInput = document.getElementById("nome");
  const emailInput = document.getElementById("email");
  const telefoneInput = document.getElementById("telefone");
  const documentoInput = document.getElementById("documento");
  const expiraEmInput = document.getElementById("expiraEm");
  const senhaInput = document.getElementById("senha");
  const ativoInput = document.getElementById("ativo");

  let colaboradores = [];
  let tabelaColaboradores = null;

  function toLocalInputValue(value) {
    if (!value) return "";
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) return "";
    const pad = (n) => String(n).padStart(2, "0");
    return `${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
  }

  function formatarDataHora(value) {
    if (!value) return "-";
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) return "-";
    return dt.toLocaleString("pt-BR", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  }

  function diffDias(dataAlvo) {
    const agora = new Date();
    const base = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate()).getTime();
    const alvo = new Date(dataAlvo.getFullYear(), dataAlvo.getMonth(), dataAlvo.getDate()).getTime();
    return Math.round((alvo - base) / (24 * 60 * 60 * 1000));
  }

  function getStatusExpiracao(colab) {
    if (!colab.expira_em) {
      return {
        chave: "sem_data",
        label: "Sem validade",
        classe: "bg-slate-700/30 border border-slate-600/70 text-slate-200",
      };
    }

    const dt = new Date(colab.expira_em);
    if (Number.isNaN(dt.getTime())) {
      return {
        chave: "sem_data",
        label: "Sem validade",
        classe: "bg-slate-700/30 border border-slate-600/70 text-slate-200",
      };
    }

    const dias = diffDias(dt);
    if (dias < 0) {
      return {
        chave: "expirados",
        label: "Expirado",
        classe: "bg-rose-500/10 border border-rose-500/60 text-rose-300",
      };
    }

    if (dias <= 30) {
      return {
        chave: "vence",
        label: `Vence em ${dias} dia(s)`,
        classe: "bg-amber-500/10 border border-amber-500/60 text-amber-300",
      };
    }

    return {
      chave: "validos",
      label: "Vigente",
      classe: "bg-sky-500/10 border border-sky-500/60 text-sky-300",
    };
  }

  function atualizarIndicadores() {
    const total = colaboradores.length;
    const ativos = colaboradores.filter((c) => c.ativo).length;
    const inativos = total - ativos;
    const expirados = colaboradores.filter((c) => getStatusExpiracao(c).chave === "expirados").length;

    statTotal.textContent = String(total);
    statAtivos.textContent = String(ativos);
    statInativos.textContent = String(inativos);
    statExpirados.textContent = String(expirados);
  }

  function destruirTabelaPaginada() {
    if (!tabelaColaboradores) return;
    tabelaColaboradores.destroy();
    tabelaColaboradores = null;
  }

  function inicializarTabelaPaginada() {
    if (!tableColaboradores || typeof DataTable !== "function") return;
    destruirTabelaPaginada();

    tabelaColaboradores = new DataTable(tableColaboradores, {
      paging: true,
      pageLength: 5,
      lengthMenu: [10, 25, 50, 100],
      searching: false,
      ordering: true,
      info: true,
      order: [[0, "asc"]],
      autoWidth: false,
      columnDefs: [
        { targets: [5], orderable: false },
      ],
      language: {
        emptyTable: "Nenhum colaborador encontrado.",
        lengthMenu: "_MENU_ por pagina",
        paginate: {
          first: "Primeira",
          previous: "Anterior",
          next: "Proxima",
          last: "Ultima",
        },
      },
    });
  }

  function abrirModal(colab = null) {
    modalError.classList.add("hidden");

    if (colab) {
      modalTitle.textContent = "Editar colaborador";
      colaboradorIdInput.value = colab.id;
      nomeInput.value = colab.nome || "";
      emailInput.value = colab.email || "";
      telefoneInput.value = colab.telefone || "";
      documentoInput.value = colab.documento || "";
      expiraEmInput.value = toLocalInputValue(colab.expira_em);
      senhaInput.value = "";
      senhaInput.required = false;
      senhaInput.placeholder = "Deixe em branco para manter";
      ativoInput.checked = colab.ativo;
    } else {
      modalTitle.textContent = "Novo colaborador";
      colaboradorIdInput.value = "";
      nomeInput.value = "";
      emailInput.value = "";
      telefoneInput.value = "";
      documentoInput.value = "";
      expiraEmInput.value = "";
      senhaInput.value = "";
      senhaInput.required = true;
      senhaInput.placeholder = "Defina a senha";
      ativoInput.checked = true;
    }

    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function fecharModal() {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  function filtrarColaboradores() {
    const termo = searchInput.value.toLowerCase().trim();
    const status = statusFilter.value;
    const expira = expiraFilter.value;

    return colaboradores.filter((c) => {
      const alvo = [
        c.nome || "",
        c.email || "",
        c.documento || "",
        c.telefone || "",
      ].join(" ").toLowerCase();

      if (termo && !alvo.includes(termo)) return false;

      if (status === "ativos" && !c.ativo) return false;
      if (status === "inativos" && c.ativo) return false;

      const stExp = getStatusExpiracao(c).chave;
      if (expira !== "todos" && stExp !== expira) return false;

      return true;
    });
  }

  function renderTabela() {
    const filtrados = filtrarColaboradores();
    destruirTabelaPaginada();
    tableBody.innerHTML = "";

    if (filtrados.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="px-3 py-8 text-center text-xs text-slate-400">
            Nenhum colaborador encontrado para os filtros aplicados.
          </td>
        </tr>
      `;
    } else {
      for (const c of filtrados) {
        const stExp = getStatusExpiracao(c);
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-900/60 transition";

        tr.innerHTML = `
          <td class="px-3 py-2.5 align-middle">
            <div class="flex flex-col">
              <span class="font-medium text-slate-100">${c.nome}</span>
              ${c.documento ? `<span class="text-[11px] text-slate-400">${c.documento}</span>` : `<span class="text-[11px] text-slate-500">Sem documento</span>`}
            </div>
          </td>
          <td class="px-3 py-2.5 align-middle">
            <div class="flex flex-col">
              <span class="text-slate-200">${c.email || "-"}</span>
              <span class="text-[11px] text-slate-400">${c.telefone || "-"}</span>
            </div>
          </td>
          <td class="px-3 py-2.5 align-middle text-slate-300">${c.documento || "-"}</td>
          <td class="px-3 py-2.5 align-middle" data-order="${c.expira_em || ""}">
            <div class="flex flex-col gap-1">
              <span class="text-slate-200">${formatarDataHora(c.expira_em)}</span>
              <span class="inline-flex w-fit px-2 py-0.5 text-[10px] rounded-full ${stExp.classe}">
                ${stExp.label}
              </span>
            </div>
          </td>
          <td class="px-3 py-2.5 align-middle" data-order="${c.ativo ? "1" : "0"}">
            ${
              c.ativo
                ? `<span class="px-2 py-1 text-[11px] rounded-full bg-emerald-500/15 border border-emerald-500/40 text-emerald-300">Ativo</span>`
                : `<span class="px-2 py-1 text-[11px] rounded-full bg-slate-700/40 border border-slate-600/80 text-slate-200">Inativo</span>`
            }
          </td>
          <td class="px-3 py-2.5 align-middle text-right">
            <button
              class="text-xs px-2.5 py-1 rounded-lg bg-slate-900/80 border border-slate-700/80 text-slate-200 hover:border-emerald-400 hover:text-emerald-300 mr-2"
              data-action="edit"
              data-id="${c.id}"
            >
              Editar
            </button>
            <button
              class="text-xs px-2.5 py-1 rounded-lg bg-rose-500/10 border border-rose-500/60 text-rose-300 hover:bg-rose-500/20"
              data-action="delete"
              data-id="${c.id}"
            >
              Remover
            </button>
          </td>
        `;

        tableBody.appendChild(tr);
      }

      inicializarTabelaPaginada();
    }

    countInfo.textContent = `${filtrados.length} colaborador(es) visivel(is) de ${colaboradores.length}`;
    atualizarIndicadores();
  }

  async function carregarColaboradores() {
    countInfo.textContent = "Carregando colaboradores...";
    try {
      const res = await fetch("/api/colaboradores/");
      if (!res.ok) throw new Error("Erro ao carregar");
      colaboradores = await res.json();
      renderTabela();
    } catch (err) {
      console.error(err);
      countInfo.textContent = "Erro ao carregar colaboradores.";
      destruirTabelaPaginada();
      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="px-3 py-8 text-center text-xs text-rose-400">
            Nao foi possivel carregar os colaboradores.
          </td>
        </tr>
      `;
      atualizarIndicadores();
    }
  }

  tableBody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    const action = btn.getAttribute("data-action");
    const colab = colaboradores.find((c) => c.id == id);
    if (!colab) return;

    if (action === "edit") {
      abrirModal(colab);
    } else if (action === "delete") {
      if (!confirm(`Remover o colaborador "${colab.nome}"?`)) return;
      try {
        const res = await fetch(`/api/colaboradores/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Erro ao remover");
        colaboradores = colaboradores.filter((c) => c.id != id);
        renderTabela();
      } catch (err) {
        console.error(err);
        alert("Erro ao remover colaborador.");
      }
    }
  });

  btnNovo.addEventListener("click", () => abrirModal());
  modalClose.addEventListener("click", fecharModal);
  btnCancelar.addEventListener("click", fecharModal);
  modal.addEventListener("click", (e) => {
    if (e.target === modal) fecharModal();
  });

  modalForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    modalError.classList.add("hidden");

    if (!modalForm.reportValidity()) {
      return;
    }

    const id = colaboradorIdInput.value;
    const senha = senhaInput.value.trim();

    if (!id && !senha) {
      modalError.textContent = "Informe uma senha para o colaborador.";
      modalError.classList.remove("hidden");
      return;
    }

    const payload = {
      nome: nomeInput.value.trim(),
      email: emailInput.value.trim() || null,
      telefone: telefoneInput.value.trim() || null,
      documento: documentoInput.value.trim() || null,
      expira_em: expiraEmInput.value ? new Date(expiraEmInput.value).toISOString() : null,
      ativo: ativoInput.checked,
    };

    if (senha) {
      payload.senha = senha;
    }

    const url = id ? `/api/colaboradores/${id}` : "/api/colaboradores/";
    const method = id ? "PUT" : "POST";

    try {
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        let errorText = "Ocorreu um erro ao salvar. Verifique os dados e tente novamente.";
        try {
          const err = await res.json();
          if (typeof err.detail === "string") {
            errorText = err.detail;
          } else if (Array.isArray(err.detail) && err.detail.length) {
            errorText = err.detail.map((item) => item.msg || "Dados invalidos.").join(", ");
          }
        } catch (_) {
          // Mantem mensagem padrao.
        }
        modalError.textContent = errorText;
        modalError.classList.remove("hidden");
        return;
      }

      const colab = await res.json();

      if (id) {
        const idx = colaboradores.findIndex((c) => c.id == id);
        if (idx >= 0) colaboradores[idx] = colab;
      } else {
        colaboradores.push(colab);
      }

      renderTabela();
      fecharModal();
    } catch (err) {
      console.error(err);
      modalError.textContent = "Ocorreu um erro ao salvar. Verifique os dados e tente novamente.";
      modalError.classList.remove("hidden");
    }
  });

  searchInput.addEventListener("input", renderTabela);
  statusFilter.addEventListener("change", renderTabela);
  expiraFilter.addEventListener("change", renderTabela);

  atualizarIndicadores();
  carregarColaboradores();
</script>
{% endblock %}

