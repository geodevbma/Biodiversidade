{% extends "base.html" %}

{% block title %}Dashboard • Biodiversidade{% endblock %}

{% block header_title %}Visão Geral{% endblock %}

{% block header_subtitle %}
<p class="text-[13px] text-slate-400 font-medium">
  Monitoramento em tempo real • <span class="text-emerald-400">{{ user.nome }}</span>
</p>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  /* Fundo com textura sutil */
  .bg-noise {
    position: fixed;
    inset: 0;
    z-index: -1;
    background-color: rgba(var(--surface-950-rgb), 0.98);
    background-image: url("https://grainy-gradients.vercel.app/noise.svg");
    opacity: 0.05;
    pointer-events: none;
  }

  /* Estilo base dos Cards */
  .bento-card {
    @apply relative bg-slate-900/60 backdrop-blur-md border border-slate-800/60 rounded-2xl overflow-hidden transition-all duration-300;
  }
  .bento-card:hover {
    @apply border-emerald-500/30 shadow-[0_0_30px_-10px_rgba(16,185,129,0.1)];
  }

  /* Scrollbar fina para tabelas/listas */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgb(var(--text-500-rgb)); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: rgb(var(--text-600-rgb)); }

  #map { z-index: 1; height: 100%; width: 100%; background: rgb(var(--surface-900-rgb)); }
  .foto-ratio { aspect-ratio: 4 / 3; }
  .assinatura-ratio { aspect-ratio: 3 / 1; }
</style>
{% endblock %}

{% block content %}
<div class="bg-noise"></div>

<div class="space-y-5 pb-10 animate-fadeUp">
  
  <div class="sticky top-4 z-20 bento-card p-2 px-4 shadow-xl shadow-slate-950/50">
    <form id="filter-form" class="flex flex-wrap items-center gap-3 justify-between">
      
      <div class="hidden md:flex items-center gap-2 pr-4 border-r border-slate-800/80">
        <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
        <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Filtros</span>
      </div>

      <div class="flex flex-wrap gap-2 items-center flex-1">
        <div class="relative group">
          <input type="date" id="data-inicio" class="w-32 bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded-lg px-2 py-1.5 focus:border-emerald-500 outline-none">
          <span class="absolute -top-2 left-2 px-1 bg-slate-900 text-[9px] text-slate-500">De</span>
        </div>
        
        <div class="relative group">
          <input type="date" id="data-fim" class="w-32 bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded-lg px-2 py-1.5 focus:border-emerald-500 outline-none">
          <span class="absolute -top-2 left-2 px-1 bg-slate-900 text-[9px] text-slate-500">Até</span>
        </div>

        <select id="projeto" class="w-full md:w-48 bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded-lg px-2 py-1.5 focus:border-emerald-500 outline-none">
          <option value="">Todos os Projetos</option>
          {% for proj in projetos %}
            <option value="{{ proj }}">{{ proj }}</option>
          {% endfor %}
        </select>

        <select id="tipo-registro" class="w-full md:w-48 bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded-lg px-2 py-1.5 focus:border-emerald-500 outline-none">
          <option value="">Todos os tipos</option>
          <option value="fauna">Fauna</option>
          <option value="flora">Flora</option>
          <option value="inventario_florestal">Inventario florestal</option>
        </select>
      </div>

      <div class="flex items-center gap-2">
        <button type="button" id="btn-aplicar" class="px-4 py-1.5 bg-emerald-500 hover:bg-emerald-400 text-slate-950 text-xs font-bold rounded-lg transition-colors shadow shadow-emerald-500/20">
          Atualizar
        </button>
        <button type="button" id="btn-limpar" class="p-1.5 text-slate-400 hover:text-white transition-colors" title="Limpar Filtros">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
    </form>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bento-card p-4 flex items-center justify-between group">
      <div>
        <p class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold mb-1">Registros Totais</p>
        <h3 id="kpi-total" class="text-3xl font-bold text-slate-100 group-hover:text-emerald-400 transition-colors">--</h3>
      </div>
      <div class="h-10 w-10 rounded-full bg-slate-800 flex items-center justify-center text-emerald-500 group-hover:bg-emerald-500/10 transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
      </div>
    </div>

    <div class="bento-card p-4 flex items-center justify-between group">
      <div>
        <p class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold mb-1">Espécies Únicas</p>
        <h3 id="kpi-especies" class="text-3xl font-bold text-slate-100">--</h3>
      </div>
      <div class="h-10 w-10 rounded-full bg-slate-800 flex items-center justify-center text-blue-400 group-hover:bg-blue-500/10 transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path></svg>
      </div>
    </div>

    <div class="bento-card p-4 flex items-center justify-between group">
      <div>
        <p class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold mb-1">Projetos Ativos</p>
        <h3 id="kpi-projetos" class="text-3xl font-bold text-slate-100">--</h3>
      </div>
      <div class="h-10 w-10 rounded-full bg-slate-800 flex items-center justify-center text-purple-400 group-hover:bg-purple-500/10 transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
      </div>
    </div>
    
    <div class="bento-card p-4 flex items-center justify-between group">
      <div>
        <p class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold mb-1">Registros com GPS</p>
        <h3 id="kpi-gps" class="text-3xl font-bold text-slate-100">--</h3>
      </div>
      <div class="h-10 w-10 rounded-full bg-slate-800 flex items-center justify-center text-amber-400 group-hover:bg-amber-500/10 transition-all">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 h-auto lg:h-[500px]">
    
    <div class="lg:col-span-8 bento-card flex flex-col">
      <div class="px-4 py-3 border-b border-slate-800 flex justify-between items-center">
        <h3 class="text-sm font-semibold text-slate-100 flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
          Distribuição Geográfica
        </h3>
        <div class="flex gap-2">
            <button
              id="btn-basemap-satelite"
              type="button"
              class="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded text-slate-300 transition-colors"
            >
              Satélite
            </button>
            <button
              id="btn-basemap-terreno"
              type="button"
              class="text-[10px] bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded text-slate-300 transition-colors"
            >
              Terreno
            </button>
        </div>
      </div>
      <div class="flex-1 relative bg-slate-900 group">
        <div id="map"></div>
        <div class="absolute bottom-4 left-4 bg-slate-950/80 backdrop-blur px-3 py-1.5 rounded-lg border border-slate-800 text-[10px] text-slate-400 pointer-events-none z-[400]">
          Use <span class="text-white font-mono">Shift + Drag</span> para zoom na área
        </div>
      </div>
    </div>

    <div class="lg:col-span-4 flex flex-col gap-4">
        
        <div class="bento-card p-4 flex-1 flex flex-col">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xs font-semibold text-slate-200 uppercase tracking-wide">Por Categoria Biológica</h3>
                <button class="text-slate-500 hover:text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg></button>
            </div>
            <div class="flex-1 relative min-h-[180px]">
                <canvas id="grafico-tipo"></canvas>
            </div>
        </div>

        <div class="bento-card p-4 flex-1 flex flex-col">
            <div class="flex justify-between items-start mb-2">
                <h3 class="text-xs font-semibold text-slate-200 uppercase tracking-wide">Top Projetos</h3>
            </div>
            <div class="flex-1 relative min-h-[150px]">
                <canvas id="grafico-projeto"></canvas>
            </div>
        </div>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-4">
    <div class="bento-card p-5">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-sm font-semibold text-slate-100">Evolução Temporal dos Registros</h3>
          <p class="text-[11px] text-slate-500 mt-0.5">Volume de dados coletados nos últimos 12 meses</p>
        </div>
        <div class="flex gap-4 text-[10px]">
            <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-emerald-400"></span>Validados</div>
            <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-slate-600"></span>Pendentes</div>
        </div>
      </div>
      <div class="relative w-full h-[220px]">
        <canvas id="grafico-data"></canvas>
      </div>
    </div>
  </div>

</div>

<div id="detalhes-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur-sm">
  <div class="w-full max-w-4xl mx-4 bg-slate-950 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl">
    <div class="px-4 py-3 flex items-center justify-between border-b border-slate-800">
      <div>
        <p class="text-sm font-semibold text-emerald-400">Detalhes do Registro</p>
        <p id="detalhes-subtitle" class="text-[11px] text-slate-400">Selecione um ponto no mapa</p>
      </div>
      <button
        id="btn-fechar-detalhes"
        type="button"
        class="px-2.5 py-1.5 rounded-lg border border-slate-700 text-[11px] text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
      >
        Fechar
      </button>
    </div>
    <div class="p-4 bg-slate-950 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <p class="text-[11px] uppercase tracking-wider text-slate-500">Informacoes</p>
          <div id="detalhes-list" class="space-y-2 text-[12px] text-slate-200"></div>
        </div>
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <p class="text-[11px] uppercase tracking-wider text-slate-500">Registro Fotografico</p>
            <span id="fotos-count" class="text-[10px] text-slate-500">0 foto(s)</span>
          </div>
          <p id="fotos-resumo" class="text-[11px] text-slate-500">Sem fotos para este registro.</p>
          <button
            id="btn-ver-fotos"
            type="button"
            class="px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-950 text-xs font-semibold disabled:opacity-60 disabled:cursor-not-allowed"
            disabled
          >
            Ver fotos
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="fotos-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur-sm">
  <div class="w-full max-w-4xl mx-4 bg-slate-950 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl">
    <div class="px-4 py-3 flex items-center justify-between border-b border-slate-800">
      <div>
        <p class="text-sm font-semibold text-emerald-400">Registro Fotografico</p>
        <p id="fotos-subtitle" class="text-[11px] text-slate-400">-</p>
      </div>
      <div class="flex items-center gap-2">
        <button
          id="btn-foto-anterior"
          type="button"
          class="px-2.5 py-1.5 rounded-lg border border-slate-700 text-[11px] text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
          title="Foto anterior"
        >
          &larr;
        </button>
        <button
          id="btn-foto-proxima"
          type="button"
          class="px-2.5 py-1.5 rounded-lg border border-slate-700 text-[11px] text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
          title="Proxima foto"
        >
          &rarr;
        </button>
        <button
          id="btn-fechar-fotos"
          type="button"
          class="px-2.5 py-1.5 rounded-lg border border-slate-700 text-[11px] text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
        >
          Fechar
        </button>
      </div>
    </div>
    <div class="p-4 bg-slate-950 space-y-3">
      <div id="fotos-empty" class="hidden text-center text-[11px] text-slate-500 py-8">
        Nenhuma foto disponivel para este registro.
      </div>
      <div id="fotos-carousel" class="space-y-3">
        <div class="foto-ratio relative w-full rounded-xl border border-slate-800 bg-slate-900/60 overflow-hidden">
          <img id="foto-carousel-img" alt="Foto do registro" class="h-full w-full object-contain hidden" loading="lazy" />
          <div id="foto-carousel-placeholder" class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-500">
            Sem foto
          </div>
        </div>
        <div class="flex items-center justify-between text-[11px] text-slate-400">
          <span id="foto-carousel-label">-</span>
          <span id="foto-carousel-index">0/0</span>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


  <script>
    function cssVar(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function rgbVar(name, alpha = 1) {
      const value = cssVar(name);
      return alpha === 1 ? `rgb(${value})` : `rgba(${value}, ${alpha})`;
    }

    const chartPlaceholderColor = rgbVar("--text-500-rgb");
    const chartGridColor = rgbVar("--surface-700-rgb");
    const chartAccentColor = "#10b981";

    // Configuracao padrao do Chart.js por modo ativo
    Chart.defaults.color = rgbVar("--text-400-rgb");
    Chart.defaults.borderColor = rgbVar("--surface-800-rgb");
    Chart.defaults.font.family = "'Inter', sans-serif";

    // Inicializacao do Mapa
    const map = L.map('map', { zoomControl: false }).setView([-15.78, -47.93], 4);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const camadaTerreno = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap',
      maxZoom: 17
    });

    const camadaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri',
      maxZoom: 20
    });

    let basemapAtual = 'terreno';
    camadaTerreno.addTo(map);

    const markersLayer = L.layerGroup().addTo(map);
    map.on('moveend', () => {
      if (registrosFiltrados.length) {
        aplicarViewport();
      }
    });

    const kpiTotal = document.getElementById('kpi-total');
    const kpiEspecies = document.getElementById('kpi-especies');
    const kpiProjetos = document.getElementById('kpi-projetos');
    const kpiGps = document.getElementById('kpi-gps');

    const dataInicio = document.getElementById('data-inicio');
    const dataFim = document.getElementById('data-fim');
    const projeto = document.getElementById('projeto');
    const tipoRegistro = document.getElementById('tipo-registro');
    const btnAplicar = document.getElementById('btn-aplicar');
    const btnLimpar = document.getElementById('btn-limpar');
    const btnBasemapSatelite = document.getElementById('btn-basemap-satelite');
    const btnBasemapTerreno = document.getElementById('btn-basemap-terreno');
    const detalhesModal = document.getElementById('detalhes-modal');
    const btnFecharDetalhes = document.getElementById('btn-fechar-detalhes');
    const detalhesSubtitle = document.getElementById('detalhes-subtitle');
    const detalhesList = document.getElementById('detalhes-list');
    const fotosCount = document.getElementById('fotos-count');
    const fotosResumo = document.getElementById('fotos-resumo');
    const btnVerFotos = document.getElementById('btn-ver-fotos');

    const fotosModal = document.getElementById('fotos-modal');
    const btnFecharFotos = document.getElementById('btn-fechar-fotos');
    const btnFotoAnterior = document.getElementById('btn-foto-anterior');
    const btnFotoProxima = document.getElementById('btn-foto-proxima');
    const fotosSubtitle = document.getElementById('fotos-subtitle');
    const fotosEmpty = document.getElementById('fotos-empty');
    const fotosCarousel = document.getElementById('fotos-carousel');
    const fotoCarouselImg = document.getElementById('foto-carousel-img');
    const fotoCarouselPlaceholder = document.getElementById('foto-carousel-placeholder');
    const fotoCarouselLabel = document.getElementById('foto-carousel-label');
    const fotoCarouselIndex = document.getElementById('foto-carousel-index');

    let registros = [];
    let registrosFiltrados = [];
    let registroSelecionado = null;
    let fotosAtuais = [];
    let fotoIndex = 0;

    function atualizarEstadoBasemap() {
      if (!btnBasemapSatelite || !btnBasemapTerreno) return;

      const ativoClasses = ['bg-emerald-900/30', 'border', 'border-emerald-500/30', 'text-emerald-400'];
      const inativoClasses = ['bg-slate-800', 'hover:bg-slate-700', 'text-slate-300'];

      const setEstado = (btn, ativo) => {
        if (ativo) {
          btn.classList.remove(...inativoClasses);
          btn.classList.add(...ativoClasses);
        } else {
          btn.classList.remove(...ativoClasses);
          btn.classList.add(...inativoClasses);
        }
      };

      setEstado(btnBasemapSatelite, basemapAtual === 'satelite');
      setEstado(btnBasemapTerreno, basemapAtual === 'terreno');
    }

    function trocarBasemap(tipo) {
      if (tipo !== 'satelite' && tipo !== 'terreno') return;
      if (basemapAtual === tipo) {
        atualizarEstadoBasemap();
        return;
      }

      const camadaAnterior = basemapAtual === 'satelite' ? camadaSatelite : camadaTerreno;
      if (map.hasLayer(camadaAnterior)) {
        map.removeLayer(camadaAnterior);
      }

      const novaCamada = tipo === 'satelite' ? camadaSatelite : camadaTerreno;
      novaCamada.addTo(map);
      basemapAtual = tipo;
      atualizarEstadoBasemap();
    }

    function parseDate(iso) {
      if (!iso) return null;
      const d = new Date(iso);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    function normalizarFotoPath(valor) {
      if (valor == null) return null;
      let v = String(valor).trim();
      if (!v || v === '-' || v.toLowerCase() === 'null') return null;

      if (/^data:image\//i.test(v)) return v;
      if (/^https?:\/\//i.test(v)) return v;

      if (/^[A-Za-z0-9+/=]+$/.test(v) && v.length > 200) {
        return `data:image/png;base64,${v}`;
      }

      v = v.replace(/\\/g, '/');
      const lower = v.toLowerCase();
      const mediaIndex = lower.lastIndexOf('/media/');
      if (mediaIndex >= 0) return v.slice(mediaIndex);

      if (v.startsWith('/')) return v;
      if (lower.startsWith('media/')) return `/${v}`;
      if (lower.startsWith('fauna/')) return `/media/${v}`;
      return `/media/${v}`;
    }

    function formatarData(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return String(iso);
      return d.toLocaleDateString('pt-BR');
    }

    function formatarNumero(valor) {
      const num = Number(valor);
      return Number.isFinite(num) ? num.toFixed(6) : '-';
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function gerarPopupHtml(r) {
      const titulo = escapeHtml(r.especie || r.identificacao || 'Registro');
      const id = escapeHtml(r.id ?? '-');
      const projeto = escapeHtml(r.projeto || '-');
      const tipo = escapeHtml(r.tipo || '-');
      const especie = escapeHtml(r.especie || '-');
      const identificacao = escapeHtml(r.identificacao || '-');
      const data = escapeHtml(formatarData(r.data_registro));
      const colaborador = escapeHtml(r.colaborador_nome || '-');
      const status = escapeHtml(r.status || '-');
      const lat = escapeHtml(formatarNumero(r.latitude));
      const lon = escapeHtml(formatarNumero(r.longitude));
      const fotosDisponiveis = coletarFotos(r).length > 0;

      const btnClasses = fotosDisponiveis
        ? 'w-full mt-2 px-2 py-1 rounded-md bg-emerald-500 text-slate-950 text-[11px] font-semibold'
        : 'w-full mt-2 px-2 py-1 rounded-md bg-slate-700 text-slate-300 text-[11px] font-semibold cursor-not-allowed';

      const btnDisabled = fotosDisponiveis ? '' : 'disabled';

      return `
        <div class="space-y-1 text-[11px] text-slate-800">
          <div class="text-sm font-semibold text-slate-900">${titulo}</div>
          <div><span class="text-slate-600">ID:</span> <span class="text-slate-900">${id}</span></div>
          <div><span class="text-slate-600">Projeto:</span> <span class="text-slate-900">${projeto}</span></div>
          <div><span class="text-slate-600">Tipo:</span> <span class="text-slate-900">${tipo}</span></div>
          <div><span class="text-slate-600">Especie:</span> <span class="text-slate-900">${especie}</span></div>
          <div><span class="text-slate-600">Identificacao:</span> <span class="text-slate-900">${identificacao}</span></div>
          <div><span class="text-slate-600">Data:</span> <span class="text-slate-900">${data}</span></div>
          <div><span class="text-slate-600">Colaborador:</span> <span class="text-slate-900">${colaborador}</span></div>
          <div><span class="text-slate-600">Status:</span> <span class="text-slate-900">${status}</span></div>
          <div><span class="text-slate-600">Lat:</span> <span class="text-slate-900">${lat}</span></div>
          <div><span class="text-slate-600">Lon:</span> <span class="text-slate-900">${lon}</span></div>
          <button class="popup-ver-fotos ${btnClasses}" ${btnDisabled}>Ver fotos</button>
        </div>
      `;
    }

    function coletarFotos(r) {
      if (!r) return [];
      const fotos = [];
      const animalUrl = normalizarFotoPath(r.foto_animal_path);
      const localUrl = normalizarFotoPath(r.foto_local_path);
      const assinaturaUrl = normalizarFotoPath(r.assinatura_usuario);

      if (animalUrl) fotos.push({ label: 'Animal', url: animalUrl });
      if (localUrl) fotos.push({ label: 'Local', url: localUrl });
      if (assinaturaUrl) fotos.push({ label: 'Assinatura', url: assinaturaUrl });
      return fotos;
    }

    function atualizarResumoFotos(r) {
      fotosAtuais = coletarFotos(r);
      fotosCount.textContent = `${fotosAtuais.length} foto(s)`;
      if (fotosAtuais.length) {
        const labels = fotosAtuais.map(f => f.label).join(', ');
        fotosResumo.textContent = `Disponivel: ${labels}`;
        btnVerFotos.disabled = false;
      } else {
        fotosResumo.textContent = 'Sem fotos para este registro.';
        btnVerFotos.disabled = true;
      }
    }

    function limparDetalhes() {
      detalhesList.innerHTML = '';
    }

    function adicionarDetalhe(label, value) {
      const row = document.createElement('div');
      row.className = 'flex items-start justify-between gap-3 border-b border-slate-800/60 pb-1';
      const labelEl = document.createElement('span');
      labelEl.className = 'text-[11px] text-slate-500';
      labelEl.textContent = label;

      const valueEl = document.createElement('span');
      valueEl.className = 'text-[12px] text-slate-100 text-right break-words';
      valueEl.textContent = value;

      row.append(labelEl, valueEl);
      detalhesList.appendChild(row);
    }

    function atualizarDetalhes(r) {
      limparDetalhes();
      if (!r) return;

      adicionarDetalhe('ID', r.id ?? '-');
      adicionarDetalhe('Projeto', r.projeto || '-');
      adicionarDetalhe('Tipo', r.tipo || '-');
      adicionarDetalhe('Especie', r.especie || '-');
      adicionarDetalhe('Identificacao', r.identificacao || '-');
      adicionarDetalhe('Colaborador', r.colaborador_nome || '-');
      adicionarDetalhe('Data', formatarData(r.data_registro));
      adicionarDetalhe('Status', r.status || '-');
      adicionarDetalhe('Latitude', formatarNumero(r.latitude));
      adicionarDetalhe('Longitude', formatarNumero(r.longitude));
    }

    function abrirDetalhesModal(r) {
      if (!r || !detalhesModal) return;
      registroSelecionado = r;
      const titulo = r.especie || r.identificacao || 'Registro';
      const proj = r.projeto || '-';
      const tipo = r.tipo || '-';
      detalhesSubtitle.textContent = `${titulo} - ${proj} - ${tipo}`;
      atualizarDetalhes(r);
      atualizarResumoFotos(r);
      detalhesModal.classList.remove('hidden');
      detalhesModal.classList.add('flex');
    }

    function fecharDetalhesModal() {
      if (!detalhesModal) return;
      detalhesModal.classList.add('hidden');
      detalhesModal.classList.remove('flex');
    }

    function atualizarCarousel() {
      if (!fotosAtuais.length) {
        fotoCarouselImg.removeAttribute('src');
        fotoCarouselImg.classList.add('hidden');
        fotoCarouselPlaceholder.classList.remove('hidden');
        fotoCarouselLabel.textContent = '-';
        fotoCarouselIndex.textContent = '0/0';
        fotosEmpty.classList.remove('hidden');
        fotosCarousel.classList.add('hidden');
        btnFotoAnterior.classList.add('hidden');
        btnFotoProxima.classList.add('hidden');
        return;
      }

      const item = fotosAtuais[fotoIndex];
      fotoCarouselImg.src = item.url;
      fotoCarouselImg.classList.remove('hidden');
      fotoCarouselPlaceholder.classList.add('hidden');
      fotoCarouselLabel.textContent = item.label;
      fotoCarouselIndex.textContent = `${fotoIndex + 1}/${fotosAtuais.length}`;
      fotosEmpty.classList.add('hidden');
      fotosCarousel.classList.remove('hidden');

      const temMaisDeUma = fotosAtuais.length > 1;
      btnFotoAnterior.classList.toggle('hidden', !temMaisDeUma);
      btnFotoProxima.classList.toggle('hidden', !temMaisDeUma);
    }

    function abrirFotosModal() {
      if (!registroSelecionado || !fotosModal) return;
      const titulo = registroSelecionado.especie || registroSelecionado.identificacao || 'Registro';
      const proj = registroSelecionado.projeto || '-';
      const tipo = registroSelecionado.tipo || '-';
      fotosSubtitle.textContent = `${titulo} - ${proj} - ${tipo}`;
      fotosAtuais = coletarFotos(registroSelecionado);
      fotoIndex = 0;
      atualizarCarousel();
      fotosModal.classList.remove('hidden');
      fotosModal.classList.add('flex');
    }

    function fecharFotosModal() {
      if (!fotosModal) return;
      fotosModal.classList.add('hidden');
      fotosModal.classList.remove('flex');
    }


    function hasCoords(r) {
      const lat = Number(r.latitude);
      const lon = Number(r.longitude);
      return Number.isFinite(lat) && Number.isFinite(lon);
    }

    function filtrarRegistros() {
      const ini = dataInicio.value ? new Date(dataInicio.value) : null;
      const fim = dataFim.value ? new Date(dataFim.value) : null;
      if (fim) fim.setHours(23, 59, 59, 999);

      const proj = projeto.value;
      const tipo = (tipoRegistro.value || '').toLowerCase();

      return registros.filter(r => {
        if (proj && r.projeto !== proj) return false;

        if (tipo) {
          const rTipo = (r.tipo || '').toLowerCase();
          if (rTipo !== tipo) return false;
        }

        if (ini || fim) {
          const d = parseDate(r.data_registro);
          if (d && ini && d < ini) return false;
          if (d && fim && d > fim) return false;
        }

        return true;
      });
    }

    function filtrarPorMapa(list) {
      const bounds = map.getBounds();
      return list.filter(r => {
        if (!hasCoords(r)) return false;
        const lat = Number(r.latitude);
        const lon = Number(r.longitude);
        return bounds.contains([lat, lon]);
      });
    }


    function updateKpis(list) {
      kpiTotal.textContent = list.length.toString();

      const especiesSet = new Set();
      const projetosSet = new Set();
      let gpsCount = 0;

      for (const r of list) {
        const esp = (r.especie || r.identificacao || '').trim();
        if (esp) especiesSet.add(esp);
        if (r.projeto) projetosSet.add(r.projeto);
        if (hasCoords(r)) gpsCount += 1;
      }

      kpiEspecies.textContent = especiesSet.size.toString();
      kpiProjetos.textContent = projetosSet.size.toString();
      kpiGps.textContent = gpsCount.toString();
    }

    const chartTipo = new Chart(document.getElementById('grafico-tipo'), {
      type: 'doughnut',
      data: {
        labels: ['Sem dados'],
        datasets: [{
          data: [1],
          backgroundColor: [chartPlaceholderColor],
          borderWidth: 0,
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '75%',
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6, font: {size: 10} } }
        }
      }
    });

    const chartProjeto = new Chart(document.getElementById('grafico-projeto'), {
      type: 'bar',
      data: {
        labels: ['Sem dados'],
        datasets: [{
          label: 'Registros',
          data: [0],
          backgroundColor: chartPlaceholderColor,
          hoverBackgroundColor: chartAccentColor,
          borderRadius: 4,
          barThickness: 12
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { display: false }, y: { grid: { display: false } } },
        plugins: { legend: { display: false } }
      }
    });

    const chartData = new Chart(document.getElementById('grafico-data').getContext('2d'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Registros',
          data: [],
          fill: true,
          backgroundColor: 'rgba(16, 185, 129, 0.2)',
          borderColor: chartAccentColor,
          tension: 0.4,
          pointRadius: 0,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        scales: {
          y: { grid: { color: chartGridColor, drawBorder: false }, beginAtZero: true },
          x: { grid: { display: false } }
        },
        plugins: { legend: { display: false } }
      }
    });

    function updateCharts(list) {
      const tipoCounts = {};
      const projetoCounts = {};

      for (const r of list) {
        const tipo = r.tipo || 'Indefinido';
        tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;

        if (r.projeto) {
          projetoCounts[r.projeto] = (projetoCounts[r.projeto] || 0) + 1;
        }
      }

      const tipoLabels = Object.keys(tipoCounts);
      const tipoValues = tipoLabels.map(l => tipoCounts[l]);
      const tipoColors = ['#10b981', '#3b82f6', '#f59e0b', '#f472b6', '#a855f7', '#14b8a6'];

      chartTipo.data.labels = tipoLabels.length ? tipoLabels : ['Sem dados'];
      chartTipo.data.datasets[0].data = tipoLabels.length ? tipoValues : [1];
      chartTipo.data.datasets[0].backgroundColor = tipoLabels.length
        ? tipoLabels.map((_, i) => tipoColors[i % tipoColors.length])
        : [chartPlaceholderColor];
      chartTipo.update();

      const projetosOrdenados = Object.entries(projetoCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);

      if (projetosOrdenados.length) {
        chartProjeto.data.labels = projetosOrdenados.map(([k]) => k);
        chartProjeto.data.datasets[0].data = projetosOrdenados.map(([, v]) => v);
        chartProjeto.data.datasets[0].backgroundColor = chartPlaceholderColor;
        chartProjeto.data.datasets[0].hoverBackgroundColor = chartAccentColor;
      } else {
        chartProjeto.data.labels = ['Sem dados'];
        chartProjeto.data.datasets[0].data = [0];
        chartProjeto.data.datasets[0].backgroundColor = chartPlaceholderColor;
      }
      chartProjeto.update();

      const now = new Date();
      const labels = [];
      const buckets = {};

      for (let i = 11; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        buckets[key] = 0;
        labels.push(d.toLocaleDateString('pt-BR', { month: 'short' }));
      }

      for (const r of list) {
        const d = parseDate(r.data_registro);
        if (!d) continue;
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        if (key in buckets) buckets[key] += 1;
      }

      chartData.data.labels = labels;
      chartData.data.datasets[0].data = Object.values(buckets);
      chartData.update();
    }

    function updateMap(list) {
      markersLayer.clearLayers();
      const points = [];

      for (const r of list) {
        if (!hasCoords(r)) continue;
        const lat = Number(r.latitude);
        const lon = Number(r.longitude);
        const marker = L.circleMarker([lat, lon], {
          radius: 5,
          color: '#10b981',
          fillColor: '#10b981',
          fillOpacity: 0.85
        });
        marker.bindPopup(gerarPopupHtml(r));
        marker.on('popupopen', (ev) => {
          const popupEl = ev.popup ? ev.popup.getElement() : (marker.getPopup() ? marker.getPopup().getElement() : null);
          if (!popupEl) return;
          const btn = popupEl.querySelector('.popup-ver-fotos');
          if (!btn || btn.dataset.bound) return;
          btn.dataset.bound = '1';
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (btn.disabled) return;
            registroSelecionado = r;
            abrirFotosModal();
          });
        });
        marker.addTo(markersLayer);
        points.push([lat, lon]);
      }

      if (points.length) {
        map.fitBounds(points, { padding: [40, 40] });
      } else {
        map.setView([-15.78, -47.93], 4);
      }
    }

    function aplicarViewport() {
      const visiveis = filtrarPorMapa(registrosFiltrados);
      updateKpis(visiveis);
      updateCharts(visiveis);
    }

    function aplicarTudo() {
      registrosFiltrados = filtrarRegistros();
      updateMap(registrosFiltrados);
      aplicarViewport();
    }

    async function carregarRegistros() {
      try {
        const res = await fetch('/api/registros/');
        if (!res.ok) throw new Error('Erro ao carregar registros');
        registros = await res.json();
        aplicarTudo();
      } catch (err) {
        console.error(err);
        registros = [];
        aplicarTudo();
      }
    }

    fotoCarouselImg.addEventListener('error', () => {
      fotoCarouselImg.classList.add('hidden');
      fotoCarouselPlaceholder.classList.remove('hidden');
    });

    btnVerFotos.addEventListener('click', () => {
      if (!btnVerFotos.disabled) abrirFotosModal();
    });

    btnFotoAnterior.addEventListener('click', () => {
      if (fotosAtuais.length <= 1) return;
      fotoIndex = (fotoIndex - 1 + fotosAtuais.length) % fotosAtuais.length;
      atualizarCarousel();
    });

    btnFotoProxima.addEventListener('click', () => {
      if (fotosAtuais.length <= 1) return;
      fotoIndex = (fotoIndex + 1) % fotosAtuais.length;
      atualizarCarousel();
    });

    btnFecharDetalhes.addEventListener('click', fecharDetalhesModal);
    detalhesModal.addEventListener('click', (ev) => {
      if (ev.target === detalhesModal) fecharDetalhesModal();
    });

    btnFecharFotos.addEventListener('click', fecharFotosModal);
    fotosModal.addEventListener('click', (ev) => {
      if (ev.target === fotosModal) fecharFotosModal();
    });

    document.addEventListener('keydown', (ev) => {
      if (ev.key !== 'Escape') return;
      if (!fotosModal.classList.contains('hidden')) {
        fecharFotosModal();
      } else if (!detalhesModal.classList.contains('hidden')) {
        fecharDetalhesModal();
      }
    });

    btnAplicar.addEventListener('click', aplicarTudo);
    btnLimpar.addEventListener('click', () => {
      dataInicio.value = '';
      dataFim.value = '';
      projeto.value = '';
      tipoRegistro.value = '';
      aplicarTudo();
    });

    if (btnBasemapSatelite) {
      btnBasemapSatelite.addEventListener('click', () => trocarBasemap('satelite'));
    }
    if (btnBasemapTerreno) {
      btnBasemapTerreno.addEventListener('click', () => trocarBasemap('terreno'));
    }

    limparDetalhes();
    atualizarResumoFotos(null);
    atualizarEstadoBasemap();
    carregarRegistros();
  </script>

{% endblock %}
