{% extends "base.html" %}

{% block title %}Registros coletados • Biodiversidade{% endblock %}

{% block header_title %}Registros coletados{% endblock %}

{% block header_subtitle %}
<p class="text-[13px] text-slate-400 font-medium">
  Visualização dos dados gerados em campo pelos colaboradores
</p>
{% endblock %}

{% block content %}
<div class="space-y-5 pb-10 animate-fadeUp">
  <!-- Filtros superiores -->
  <div class="relative bg-slate-950/80 border border-slate-800/80 rounded-2xl px-4 py-3 flex flex-wrap gap-3 items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="h-1.5 w-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
      <span class="text-[11px] font-semibold uppercase tracking-[0.22em] text-slate-400">
        Filtros de registros
      </span>
    </div>

    <div class="flex flex-wrap gap-2 items-center flex-1 justify-end">
      <div class="flex items-center gap-2">
        <label for="filtro-data-inicio" class="text-[11px] text-slate-400">De:</label>
        <input
          type="date"
          id="filtro-data-inicio"
          class="w-32 bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        />
      </div>

      <div class="flex items-center gap-2">
        <label for="filtro-data-fim" class="text-[11px] text-slate-400">Até:</label>
        <input
          type="date"
          id="filtro-data-fim"
          class="w-32 bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        />
      </div>

      <div class="flex items-center gap-2 min-w-[200px]">
        <label for="filtro-projeto" class="text-[11px] text-slate-400">Projeto:</label>
        <select
          id="filtro-projeto"
          class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        >
          <option value="">Todos</option>
          {% for proj in projetos %}
            <option value="{{ proj }}">{{ proj }}</option>
          {% endfor %}
        </select>
      </div>

      <button
        id="btn-aplicar-filtros"
        type="button"
        class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-950 text-xs font-semibold
               hover:bg-emerald-400 hover:shadow-[0_0_20px_rgba(16,185,129,0.6)] transition-all"
      >
        <span>Aplicar</span>
      </button>

      <button
        id="btn-limpar-filtros"
        type="button"
        class="text-[11px] text-slate-400 hover:text-slate-100 transition"
      >
        Limpar
      </button>
    </div>
  </div>

  <!-- GRID PRINCIPAL: tabela + painel lateral -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Tabela -->
    <div class="lg:col-span-8">
      <div class="relative rounded-2xl bg-slate-950/85 border border-slate-800/80 backdrop-blur-xl">
        <div class="px-4 py-3 flex items-center justify-between border-b border-slate-800/80 text-xs">
          <div class="flex flex-col">
            <span class="font-semibold text-slate-100">Registros coletados</span>
            <span id="info-total" class="text-[11px] text-slate-500">Carregando registros...</span>
          </div>
          <div class="flex items-center gap-2">
            <input
              id="busca-texto"
              type="text"
              placeholder="Buscar por espécie, projeto, colaborador..."
              class="w-52 md:w-64 bg-slate-950 border border-slate-700 text-[11px] text-slate-200 rounded-lg px-2 py-1.5
                     outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/30"
            />
          </div>
        </div>

        <div class="max-h-[480px] overflow-auto">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-900/90 border-b border-slate-800 text-[11px] uppercase tracking-wide text-slate-400">
              <tr>
                <th class="px-3 py-2 text-left">Data</th>
                <th class="px-3 py-2 text-left">Projeto</th>
                <th class="px-3 py-2 text-left">Tipo</th>
                <th class="px-3 py-2 text-left">Espécie / Identificação</th>
                <th class="px-3 py-2 text-left">Colaborador</th>
                <th class="px-3 py-2 text-right">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody-registros" class="divide-y divide-slate-800">
              <!-- linhas via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Painel lateral: detalhes do registro selecionado -->
    <div class="lg:col-span-4">
      <div class="rounded-2xl bg-slate-950/85 border border-slate-800/80 backdrop-blur-xl p-4 h-full flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-xs font-semibold text-slate-100">Detalhes do registro</p>
            <p id="det-id" class="text-[11px] text-slate-500">Selecione um registro na tabela</p>
          </div>
          <button
            id="btn-ver-mapa"
            type="button"
            class="text-[11px] px-2 py-1 rounded-lg border border-slate-700 text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
            disabled
          >
            Ver no mapa (em breve)
          </button>
        </div>

        <div class="flex-1 space-y-3 text-[11px] text-slate-300">
          <div>
            <p class="text-slate-500">Projeto</p>
            <p id="det-projeto" class="font-medium text-slate-100">–</p>
          </div>
          <div>
            <p class="text-slate-500">Tipo de registro</p>
            <p id="det-tipo" class="font-medium text-slate-100">–</p>
          </div>
          <div>
            <p class="text-slate-500">Espécie / Identificação</p>
            <p id="det-especie" class="font-medium text-slate-100 break-words">–</p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <p class="text-slate-500">Colaborador</p>
              <p id="det-colaborador" class="font-medium text-slate-100">–</p>
            </div>
            <div>
              <p class="text-slate-500">Data</p>
              <p id="det-data" class="font-medium text-slate-100">–</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <p class="text-slate-500">Latitude</p>
              <p id="det-lat" class="font-mono text-xs text-emerald-300">–</p>
            </div>
            <div>
              <p class="text-slate-500">Longitude</p>
              <p id="det-lon" class="font-mono text-xs text-emerald-300">–</p>
            </div>
          </div>
          <div>
            <p class="text-slate-500">Status</p>
            <span id="det-status" class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-slate-800 text-slate-200">
              –
            </span>
          </div>
        </div>

        <div class="pt-4 border-t border-slate-800 mt-4 text-[11px] text-slate-500">
          Esta seção será integrada com as fotos do registro e o mapa interativo nas próximas etapas.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de fotos (estrutura básica para depois ligar com backend) -->
<div class="modal fade" id="fotosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-slate-950 text-slate-100 border border-slate-800">
      <div class="modal-header border-b border-slate-800">
        <h5 class="modal-title text-sm font-semibold">Fotos do registro</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body p-0 bg-black">
        <div id="fotosCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner" id="carousel-inner">
            <!-- fotos via JS -->
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#fotosCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#fotosCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const tbody = document.getElementById("tbody-registros");
  const infoTotal = document.getElementById("info-total");
  const buscaTexto = document.getElementById("busca-texto");
  const filtroDataInicio = document.getElementById("filtro-data-inicio");
  const filtroDataFim = document.getElementById("filtro-data-fim");
  const filtroProjeto = document.getElementById("filtro-projeto");
  const btnAplicar = document.getElementById("btn-aplicar-filtros");
  const btnLimpar = document.getElementById("btn-limpar-filtros");

  const detId = document.getElementById("det-id");
  const detProjeto = document.getElementById("det-projeto");
  const detTipo = document.getElementById("det-tipo");
  const detEspecie = document.getElementById("det-especie");
  const detColaborador = document.getElementById("det-colaborador");
  const detData = document.getElementById("det-data");
  const detLat = document.getElementById("det-lat");
  const detLon = document.getElementById("det-lon");
  const detStatus = document.getElementById("det-status");
  const btnVerMapa = document.getElementById("btn-ver-mapa");

  let registros = [];
  let registroSelecionado = null;

  function formatarData(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleDateString("pt-BR");
  }

  function aplicarFiltrosLocal() {
    const termo = buscaTexto.value.toLowerCase();
    const proj = filtroProjeto.value;
    const dataIni = filtroDataInicio.value ? new Date(filtroDataInicio.value) : null;
    const dataFim = filtroDataFim.value ? new Date(filtroDataFim.value) : null;

    let filtrados = registros.filter(r => {
      // texto
      const textoAlvo = [
        r.especie || "",
        r.identificacao || "",
        r.projeto || "",
        r.colaborador_nome || ""
      ].join(" ").toLowerCase();

      if (termo && !textoAlvo.includes(termo)) return false;

      // projeto
      if (proj && r.projeto !== proj) return false;

      // datas
      if (dataIni || dataFim) {
        const d = r.data_registro ? new Date(r.data_registro) : null;
        if (d && dataIni && d < dataIni) return false;
        if (d && dataFim && d > dataFim) return false;
      }

      return true;
    });

    renderTabela(filtrados);
  }

  function renderTabela(lista) {
    tbody.innerHTML = "";

    if (!lista.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="px-3 py-4 text-center text-[11px] text-slate-500">
            Nenhum registro encontrado com os filtros atuais.
          </td>
        </tr>
      `;
    } else {
      for (const r of lista) {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-900/70 transition cursor-pointer";

        tr.innerHTML = `
          <td class="px-3 py-2 align-middle text-[11px] text-slate-300">
            ${formatarData(r.data_registro)}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.projeto || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.tipo || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-100">
            ${r.especie || r.identificacao || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.colaborador_nome || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-right text-[11px]">
            <button
              class="px-2 py-1 rounded-lg border border-slate-700 text-slate-200 hover:border-emerald-400 hover:text-emerald-300 transition"
              data-id="${r.id}"
            >
              Detalhes
            </button>
          </td>
        `;

        tr.addEventListener("click", (ev) => {
          // Evitar duplicar quando clica no botão
          if (ev.target.tagName.toLowerCase() === "button") {
            selecionarRegistro(r);
          } else {
            selecionarRegistro(r);
          }
        });

        tbody.appendChild(tr);
      }
    }

    infoTotal.textContent = `${lista.length} registro(s) listado(s)`;
  }

  function selecionarRegistro(r) {
    registroSelecionado = r;
    detId.textContent = `ID: ${r.id ?? "-"}`;
    detProjeto.textContent = r.projeto || "-";
    detTipo.textContent = r.tipo || "-";
    detEspecie.textContent = r.especie || r.identificacao || "-";
    detColaborador.textContent = r.colaborador_nome || "-";
    detData.textContent = formatarData(r.data_registro);
    detLat.textContent = r.latitude != null ? Number(r.latitude).toFixed(6) : "-";
    detLon.textContent = r.longitude != null ? Number(r.longitude).toFixed(6) : "-";

    if (r.status === "VALIDADO") {
      detStatus.textContent = "Validado";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-emerald-500/15 border border-emerald-500/40 text-emerald-300";
    } else if (r.status === "PENDENTE") {
      detStatus.textContent = "Pendente";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-amber-500/10 border border-amber-500/40 text-amber-300";
    } else {
      detStatus.textContent = r.status || "–";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-slate-800 text-slate-200";
    }

    btnVerMapa.disabled = false;
  }

  async function carregarRegistros() {
    infoTotal.textContent = "Carregando registros...";
    try {
      const res = await fetch("/api/registros/");
      if (!res.ok) throw new Error("Erro ao carregar");
      registros = await res.json();
      aplicarFiltrosLocal();
    } catch (err) {
      console.error(err);
      infoTotal.textContent = "Erro ao carregar registros.";
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="px-3 py-4 text-center text-[11px] text-rose-400">
            Erro ao carregar registros do servidor.
          </td>
        </tr>
      `;
    }
  }

  // Eventos
  buscaTexto.addEventListener("input", aplicarFiltrosLocal);
  btnAplicar.addEventListener("click", aplicarFiltrosLocal);
  btnLimpar.addEventListener("click", () => {
    filtroDataInicio.value = "";
    filtroDataFim.value = "";
    filtroProjeto.value = "";
    buscaTexto.value = "";
    aplicarFiltrosLocal();
  });

  // Inicial
  carregarRegistros();
</script>
{% endblock %}
