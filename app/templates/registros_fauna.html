{% extends "base.html" %}

{% block title %}Registros coletados - Fauna â€¢ Biodiversidade{% endblock %}

{% block header_title %}Registros coletados - Fauna{% endblock %}

{% block header_subtitle %}
<p class="text-[13px] text-slate-400 font-medium">
  Visualizacao dos registros de fauna coletados em campo
</p>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #mapa-fauna { height: 420px; width: 100%; }
  .foto-ratio { aspect-ratio: 4 / 3; }
  .assinatura-ratio { aspect-ratio: 3 / 1; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-5 pb-10 animate-fadeUp">
  <!-- Filtros superiores -->
  <div class="relative bg-slate-950/80 border border-slate-800/80 rounded-2xl px-4 py-3 flex flex-wrap gap-3 items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="h-1.5 w-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
      <span class="text-[11px] font-semibold uppercase tracking-[0.22em] text-slate-400">
        Filtros de registros
      </span>
    </div>

    <div class="flex flex-wrap gap-2 items-center flex-1 justify-end">
      <div class="flex items-center gap-2">
        <label for="filtro-data-inicio" class="text-[11px] text-slate-400">De:</label>
        <input
          type="date"
          id="filtro-data-inicio"
          class="w-32 bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        />
      </div>

      <div class="flex items-center gap-2">
        <label for="filtro-data-fim" class="text-[11px] text-slate-400">Ate:</label>
        <input
          type="date"
          id="filtro-data-fim"
          class="w-32 bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        />
      </div>

      <div class="flex items-center gap-2 min-w-[200px]">
        <label for="filtro-municipio" class="text-[11px] text-slate-400">Municipio:</label>
        <select
          id="filtro-municipio"
          class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        >
          <option value="">Todos</option>
          {% for muni in municipios %}
            <option value="{{ muni }}">{{ muni }}</option>
          {% endfor %}
        </select>
      </div>

      <button
        id="btn-aplicar-filtros"
        type="button"
        class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-950 text-xs font-semibold
               hover:bg-emerald-400 hover:shadow-[0_0_20px_rgba(16,185,129,0.6)] transition-all"
      >
        <span>Aplicar</span>
      </button>

      <button
        id="btn-limpar-filtros"
        type="button"
        class="text-[11px] text-slate-400 hover:text-slate-100 transition"
      >
        Limpar
      </button>
    </div>
  </div>

  <!-- GRID PRINCIPAL: tabela + painel lateral -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Tabela -->
    <div class="lg:col-span-8">
      <div class="relative rounded-2xl bg-slate-950/85 border border-slate-800/80 backdrop-blur-xl">
        <div class="px-4 py-3 flex items-center justify-between border-b border-slate-800/80 text-xs">
          <div class="flex flex-col">
            <span class="font-semibold text-slate-100">Registros de fauna</span>
            <span id="info-total" class="text-[11px] text-slate-500">Carregando registros...</span>
          </div>
          <div class="flex items-center gap-2">
            <input
              id="busca-texto"
              type="text"
              placeholder="Buscar por especie, municipio, biologo..."
              class="w-52 md:w-64 bg-slate-950 border border-slate-700 text-[11px] text-slate-200 rounded-lg px-2 py-1.5
                     outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/30"
            />
          </div>
        </div>

        <div class="max-h-[480px] overflow-auto">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-900/90 border-b border-slate-800 text-[11px] uppercase tracking-wide text-slate-400">
              <tr>
                <th class="px-3 py-2 text-left">Data</th>
                <th class="px-3 py-2 text-left">Animal</th>
                <th class="px-3 py-2 text-left">Nome cientifico</th>
                <th class="px-3 py-2 text-left">Biologo</th>
                <th class="px-3 py-2 text-left">Municipio</th>
                <th class="px-3 py-2 text-left">Colaborador</th>
                <th class="px-3 py-2 text-right">Acoes</th>
              </tr>
            </thead>
            <tbody id="tbody-registros" class="divide-y divide-slate-800">
              <!-- linhas via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Painel lateral: detalhes do registro selecionado -->
    <div class="lg:col-span-4">
      <div class="rounded-2xl bg-slate-950/85 border border-slate-800/80 backdrop-blur-xl p-4 h-full flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-xs font-semibold text-slate-100">Detalhes do registro</p>
            <p id="det-id" class="text-[11px] text-slate-500">Selecione um registro na tabela</p>
          </div>
          <button
            id="btn-ver-mapa"
            type="button"
            class="text-[11px] px-2 py-1 rounded-lg border border-slate-700 text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
            disabled
          >
            Ver no mapa
          </button>
        </div>

        <div class="flex-1 space-y-3 text-[11px] text-slate-300">
          <div>
            <p class="text-slate-500">Animal</p>
            <p id="det-animal" class="font-medium text-slate-100">-</p>
          </div>
          <div>
            <p class="text-slate-500">Nome cientifico</p>
            <p id="det-especie" class="font-medium text-slate-100 break-words">-</p>
          </div>
          <div>
            <p class="text-slate-500">Biologo responsavel</p>
            <p id="det-biologo" class="font-medium text-slate-100">-</p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <p class="text-slate-500">Municipio</p>
              <p id="det-municipio" class="font-medium text-slate-100">-</p>
            </div>
            <div>
              <p class="text-slate-500">Data</p>
              <p id="det-data" class="font-medium text-slate-100">-</p>
            </div>
          </div>
          <div>
            <p class="text-slate-500">Local de captura</p>
            <p id="det-local" class="font-medium text-slate-100 break-words">-</p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <p class="text-slate-500">Periodo</p>
              <p id="det-periodo" class="font-medium text-slate-100">-</p>
            </div>
            <div>
              <p class="text-slate-500">Estado de saude</p>
              <p id="det-saude" class="font-medium text-slate-100">-</p>
            </div>
          </div>
          <div>
            <p class="text-slate-500">Destino</p>
            <p id="det-destino" class="font-medium text-slate-100">-</p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <p class="text-slate-500">Latitude</p>
              <p id="det-lat" class="font-mono text-xs text-emerald-300">-</p>
            </div>
            <div>
              <p class="text-slate-500">Longitude</p>
              <p id="det-lon" class="font-mono text-xs text-emerald-300">-</p>
            </div>
          </div>
          <div>
            <p class="text-slate-500">Status</p>
            <span id="det-status" class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-slate-800 text-slate-200">
              -
            </span>
          </div>
        </div>

        <div class="pt-4 border-t border-slate-800 mt-4 space-y-3">
          <div class="flex items-center justify-between">
            <p class="text-[11px] uppercase tracking-wider text-slate-500">Fotos do registro</p>
            <span id="det-fotos-count" class="text-[10px] text-slate-600">0 foto(s)</span>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <p class="text-[11px] text-slate-500">Animal</p>
              <div class="foto-ratio relative w-full rounded-lg border border-slate-800 bg-slate-900/60 overflow-hidden">
                <img id="foto-animal" alt="Foto do animal" class="h-full w-full object-cover hidden" loading="lazy" />
                <div id="foto-animal-placeholder" class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-500">
                  Sem foto
                </div>
              </div>
            </div>

            <div class="space-y-1">
              <p class="text-[11px] text-slate-500">Local</p>
              <div class="foto-ratio relative w-full rounded-lg border border-slate-800 bg-slate-900/60 overflow-hidden">
                <img id="foto-local" alt="Foto do local" class="h-full w-full object-cover hidden" loading="lazy" />
                <div id="foto-local-placeholder" class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-500">
                  Sem foto
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-1">
            <p class="text-[11px] text-slate-500">Assinatura</p>
            <div class="assinatura-ratio relative w-full rounded-lg border border-slate-800 bg-slate-900/60 overflow-hidden">
              <img id="foto-assinatura" alt="Assinatura do colaborador" class="h-full w-full object-contain hidden" loading="lazy" />
              <div id="foto-assinatura-placeholder" class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-500">
                Sem assinatura
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="mapa-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur-sm">
  <div class="w-full max-w-3xl mx-4 bg-slate-950 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl">
    <div class="px-4 py-3 flex items-center justify-between border-b border-slate-800">
      <div>
        <p class="text-sm font-semibold text-slate-100">Mapa do registro</p>
        <p id="mapa-coords" class="text-[11px] text-slate-400">-</p>
      </div>
      <button
        id="btn-fechar-mapa"
        type="button"
        class="px-2.5 py-1.5 rounded-lg border border-slate-700 text-[11px] text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
      >
        Fechar
      </button>
    </div>
    <div id="mapa-fauna" class="bg-slate-900"></div>
    <div class="px-4 py-2 border-t border-slate-800 text-[11px] text-slate-500">
      Clique e arraste para navegar. Scroll para zoom.
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const tbody = document.getElementById("tbody-registros");
  const infoTotal = document.getElementById("info-total");
  const buscaTexto = document.getElementById("busca-texto");
  const filtroDataInicio = document.getElementById("filtro-data-inicio");
  const filtroDataFim = document.getElementById("filtro-data-fim");
  const filtroMunicipio = document.getElementById("filtro-municipio");
  const btnAplicar = document.getElementById("btn-aplicar-filtros");
  const btnLimpar = document.getElementById("btn-limpar-filtros");

  const detId = document.getElementById("det-id");
  const detAnimal = document.getElementById("det-animal");
  const detEspecie = document.getElementById("det-especie");
  const detBiologo = document.getElementById("det-biologo");
  const detMunicipio = document.getElementById("det-municipio");
  const detLocal = document.getElementById("det-local");
  const detPeriodo = document.getElementById("det-periodo");
  const detSaude = document.getElementById("det-saude");
  const detDestino = document.getElementById("det-destino");
  const detData = document.getElementById("det-data");
  const detLat = document.getElementById("det-lat");
  const detLon = document.getElementById("det-lon");
  const detStatus = document.getElementById("det-status");
  const btnVerMapa = document.getElementById("btn-ver-mapa");
  const mapaModal = document.getElementById("mapa-modal");
  const btnFecharMapa = document.getElementById("btn-fechar-mapa");
  const mapaCoords = document.getElementById("mapa-coords");
  const detFotosCount = document.getElementById("det-fotos-count");
  const fotoAnimal = document.getElementById("foto-animal");
  const fotoLocal = document.getElementById("foto-local");
  const fotoAssinatura = document.getElementById("foto-assinatura");
  const fotoAnimalPlaceholder = document.getElementById("foto-animal-placeholder");
  const fotoLocalPlaceholder = document.getElementById("foto-local-placeholder");
  const fotoAssinaturaPlaceholder = document.getElementById("foto-assinatura-placeholder");

  let mapa = null;
  let mapaMarker = null;

  let registros = [];
  let registroSelecionado = null;

  function formatarData(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleDateString("pt-BR");
  }

  function normalizarFotoPath(valor) {
    if (valor == null) return null;
    let v = String(valor).trim();
    if (!v || v === "-" || v.toLowerCase() === "null") return null;

    if (/^data:image\//i.test(v)) return v;
    if (/^https?:\/\//i.test(v)) return v;

    if (/^[A-Za-z0-9+/=]+$/.test(v) && v.length > 200) {
      return `data:image/png;base64,${v}`;
    }

    v = v.replace(/\\/g, "/");
    const lower = v.toLowerCase();
    const mediaIndex = lower.lastIndexOf("/media/");
    if (mediaIndex >= 0) return v.slice(mediaIndex);

    if (v.startsWith("/")) return v;
    if (lower.startsWith("media/")) return `/${v}`;
    if (lower.startsWith("fauna/")) return `/media/${v}`;
    return `/media/${v}`;
  }

  function atualizarFoto(imgEl, placeholderEl, url) {
    if (url) {
      imgEl.src = url;
      imgEl.classList.remove("hidden");
      placeholderEl.classList.add("hidden");
    } else {
      imgEl.removeAttribute("src");
      imgEl.classList.add("hidden");
      placeholderEl.classList.remove("hidden");
    }
  }

  function atualizarFotos(r) {
    if (!r) {
      atualizarFoto(fotoAnimal, fotoAnimalPlaceholder, null);
      atualizarFoto(fotoLocal, fotoLocalPlaceholder, null);
      atualizarFoto(fotoAssinatura, fotoAssinaturaPlaceholder, null);
      detFotosCount.textContent = "0 foto(s)";
      return;
    }

    const animalUrl = normalizarFotoPath(r.foto_animal_path);
    const localUrl = normalizarFotoPath(r.foto_local_path);
    const assinaturaUrl = normalizarFotoPath(r.assinatura_usuario);

    atualizarFoto(fotoAnimal, fotoAnimalPlaceholder, animalUrl);
    atualizarFoto(fotoLocal, fotoLocalPlaceholder, localUrl);
    atualizarFoto(fotoAssinatura, fotoAssinaturaPlaceholder, assinaturaUrl);

    const total = [animalUrl, localUrl, assinaturaUrl].filter(Boolean).length;
    detFotosCount.textContent = `${total} foto(s)`;
  }

  [
    [fotoAnimal, fotoAnimalPlaceholder],
    [fotoLocal, fotoLocalPlaceholder],
    [fotoAssinatura, fotoAssinaturaPlaceholder]
  ].forEach(([imgEl, placeholderEl]) => {
    imgEl.addEventListener("error", () => {
      imgEl.classList.add("hidden");
      placeholderEl.classList.remove("hidden");
    });
  });

  function aplicarFiltrosLocal() {
    const termo = buscaTexto.value.toLowerCase();
    const muni = filtroMunicipio.value;
    const dataIni = filtroDataInicio.value ? new Date(filtroDataInicio.value) : null;
    const dataFim = filtroDataFim.value ? new Date(filtroDataFim.value) : null;

    let filtrados = registros.filter(r => {
      const textoAlvo = [
        r.nome_cientifico || "",
        r.municipio || "",
        r.biologo_responsavel || "",
        r.colaborador_nome || "",
        r.animal_number || "",
        r.id_dispositivo || ""
      ].join(" ").toLowerCase();

      if (termo && !textoAlvo.includes(termo)) return false;
      if (muni && r.municipio !== muni) return false;

      if (dataIni || dataFim) {
        const d = r.data_captura ? new Date(r.data_captura) : null;
        if (d && dataIni && d < dataIni) return false;
        if (d && dataFim && d > dataFim) return false;
      }

      return true;
    });

    renderTabela(filtrados);
  }

  function renderTabela(lista) {
    tbody.innerHTML = "";

    if (!lista.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="px-3 py-4 text-center text-[11px] text-slate-500">
            Nenhum registro encontrado com os filtros atuais.
          </td>
        </tr>
      `;
    } else {
      for (const r of lista) {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-900/70 transition cursor-pointer";

        tr.innerHTML = `
          <td class="px-3 py-2 align-middle text-[11px] text-slate-300">
            ${formatarData(r.data_captura)}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.animal_number || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-100">
            ${r.nome_cientifico || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.biologo_responsavel || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.municipio || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.colaborador_nome || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-right text-[11px]">
            <button
              class="px-2 py-1 rounded-lg border border-slate-700 text-slate-200 hover:border-emerald-400 hover:text-emerald-300 transition"
              data-id="${r.id}"
            >
              Detalhes
            </button>
          </td>
        `;

        tr.addEventListener("click", () => selecionarRegistro(r));
        tbody.appendChild(tr);
      }
    }

    infoTotal.textContent = `${lista.length} registro(s) listado(s)`;
  }

  function selecionarRegistro(r) {
    registroSelecionado = r;
    detId.textContent = `ID: ${r.id ?? "-"} (Disp: ${r.id_dispositivo || "-"})`;
    detAnimal.textContent = r.animal_number || "-";
    detEspecie.textContent = r.nome_cientifico || "-";
    detBiologo.textContent = r.biologo_responsavel || "-";
    detMunicipio.textContent = r.municipio || "-";
    detLocal.textContent = r.local_captura || "-";
    detPeriodo.textContent = r.periodo_resgate || "-";
    detSaude.textContent = r.estado_saude || "-";
    detDestino.textContent = r.destino || "-";
    detData.textContent = formatarData(r.data_captura);
    detLat.textContent = r.latitude != null ? Number(r.latitude).toFixed(6) : "-";
    detLon.textContent = r.longitude != null ? Number(r.longitude).toFixed(6) : "-";

    const hasCoords =
      r.latitude != null &&
      r.longitude != null &&
      !Number.isNaN(Number(r.latitude)) &&
      !Number.isNaN(Number(r.longitude));
    btnVerMapa.disabled = !hasCoords;

    if (r.status === "VALIDADO") {
      detStatus.textContent = "Validado";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-emerald-500/15 border border-emerald-500/40 text-emerald-300";
    } else if (r.status === "PENDENTE") {
      detStatus.textContent = "Pendente";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-amber-500/10 border border-amber-500/40 text-amber-300";
    } else if (r.status) {
      detStatus.textContent = r.status;
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-slate-800 text-slate-200";
    } else {
      detStatus.textContent = "-";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-slate-800 text-slate-200";
    }

    if (!hasCoords) {
      btnVerMapa.title = "Sem coordenadas para este registro";
    } else {
      btnVerMapa.title = "";
    }

    atualizarFotos(r);
  }

  function abrirMapa() {
    if (!registroSelecionado) return;
    const lat = Number(registroSelecionado.latitude);
    const lon = Number(registroSelecionado.longitude);
    if (Number.isNaN(lat) || Number.isNaN(lon)) return;

    mapaCoords.textContent = `Lat ${lat.toFixed(6)}, Lon ${lon.toFixed(6)}`;
    mapaModal.classList.remove("hidden");
    mapaModal.classList.add("flex");

    if (!mapa) {
      mapa = L.map("mapa-fauna", { zoomControl: true }).setView([lat, lon], 15);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        attribution: "&copy; OpenStreetMap &copy; CARTO",
        subdomains: "abcd",
        maxZoom: 20
      }).addTo(mapa);
    } else {
      mapa.setView([lat, lon], 15);
    }

    if (mapaMarker) {
      mapaMarker.setLatLng([lat, lon]);
    } else {
      mapaMarker = L.marker([lat, lon]).addTo(mapa);
    }

    setTimeout(() => mapa.invalidateSize(), 120);
  }

  function fecharMapa() {
    mapaModal.classList.add("hidden");
    mapaModal.classList.remove("flex");
  }

  async function carregarRegistros() {
    infoTotal.textContent = "Carregando registros...";
    try {
      const res = await fetch("/api/registros-fauna/admin");
      if (!res.ok) throw new Error("Erro ao carregar");
      registros = await res.json();
      aplicarFiltrosLocal();
    } catch (err) {
      console.error(err);
      infoTotal.textContent = "Erro ao carregar registros.";
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="px-3 py-4 text-center text-[11px] text-rose-400">
            Erro ao carregar registros do servidor.
          </td>
        </tr>
      `;
    }
  }

  buscaTexto.addEventListener("input", aplicarFiltrosLocal);
  btnAplicar.addEventListener("click", aplicarFiltrosLocal);
  btnLimpar.addEventListener("click", () => {
    filtroDataInicio.value = "";
    filtroDataFim.value = "";
    filtroMunicipio.value = "";
    buscaTexto.value = "";
    aplicarFiltrosLocal();
  });

  btnVerMapa.addEventListener("click", abrirMapa);
  btnFecharMapa.addEventListener("click", fecharMapa);
  mapaModal.addEventListener("click", (ev) => {
    if (ev.target === mapaModal) fecharMapa();
  });

  atualizarFotos(null);
  carregarRegistros();
</script>
{% endblock %}
