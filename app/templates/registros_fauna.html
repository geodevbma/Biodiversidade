{% extends "base.html" %}

{% block title %}Registros coletados - Fauna â€¢ Biodiversidade{% endblock %}

{% block header_title %}Registros coletados - Fauna{% endblock %}

{% block header_subtitle %}
<p class="text-[13px] text-slate-400 font-medium">
  Visualizacao dos registros de fauna coletados em campo
</p>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #mapa-fauna { height: 420px; width: 100%; }
  .foto-ratio { aspect-ratio: 4 / 3; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-5 pb-10 animate-fadeUp">
  <!-- Filtros superiores -->
  <div class="relative bg-slate-950/80 border border-slate-800/80 rounded-2xl px-4 py-3 flex flex-wrap gap-3 items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="h-1.5 w-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
      <span class="text-[11px] font-semibold uppercase tracking-[0.22em] text-slate-400">
        Filtros de registros
      </span>
    </div>

    <div class="flex flex-wrap gap-2 items-center flex-1 justify-end">
      <div class="flex items-center gap-2">
        <label for="filtro-data-inicio" class="text-[11px] text-slate-400">De:</label>
        <input
          type="date"
          id="filtro-data-inicio"
          class="w-32 bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        />
      </div>

      <div class="flex items-center gap-2">
        <label for="filtro-data-fim" class="text-[11px] text-slate-400">Ate:</label>
        <input
          type="date"
          id="filtro-data-fim"
          class="w-32 bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        />
      </div>

      <div class="flex items-center gap-2 min-w-[200px]">
        <label for="filtro-municipio" class="text-[11px] text-slate-400">Municipio:</label>
        <select
          id="filtro-municipio"
          class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        >
          <option value="">Todos</option>
          {% for muni in municipios %}
            <option value="{{ muni }}">{{ muni }}</option>
          {% endfor %}
        </select>
      </div>

      <button
        id="btn-aplicar-filtros"
        type="button"
        class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-950 text-xs font-semibold
               hover:bg-emerald-400 hover:shadow-[0_0_20px_rgba(16,185,129,0.6)] transition-all"
      >
        <span>Aplicar</span>
      </button>

      <button
        id="btn-limpar-filtros"
        type="button"
        class="text-[11px] text-slate-400 hover:text-slate-100 transition"
      >
        Limpar
      </button>
    </div>
  </div>

  <!-- GRID PRINCIPAL: tabela + painel lateral -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Tabela -->
    <div class="lg:col-span-8">
      <div class="relative rounded-2xl bg-slate-950/85 border border-slate-800/80 backdrop-blur-xl">
        <div class="px-4 py-3 flex items-center justify-between border-b border-slate-800/80 text-xs">
          <div class="flex flex-col">
            <span class="font-semibold text-slate-100">Registros de fauna</span>
            <span id="info-total" class="text-[11px] text-slate-500">Carregando registros...</span>
          </div>
          <div class="flex flex-wrap items-center justify-end gap-2">
            <input
              id="busca-texto"
              type="text"
              placeholder="Buscar por especie, municipio, biologo..."
              class="w-52 md:w-64 bg-slate-950 border border-slate-700 text-[11px] text-slate-200 rounded-lg px-2 py-1.5
                     outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/30"
            />
            <span id="info-selecao" class="text-[11px] text-slate-400">0 selecionado(s)</span>
            <button
              id="btn-exportar-pdf"
              type="button"
              class="px-2.5 py-1.5 rounded-lg border border-emerald-500/60 text-[11px] text-emerald-300 hover:bg-emerald-500/10 transition disabled:opacity-40 disabled:cursor-not-allowed"
            >
              PDF selecionados
            </button>
            <button
              id="btn-exportar-excel-selecionados"
              type="button"
              class="px-2.5 py-1.5 rounded-lg border border-amber-500/60 text-[11px] text-amber-300 hover:bg-amber-500/10 transition disabled:opacity-40 disabled:cursor-not-allowed"
            >
              Excel selecionados
            </button>
            <button
              id="btn-exportar-excel-todos"
              type="button"
              class="px-2.5 py-1.5 rounded-lg border border-sky-500/60 text-[11px] text-sky-300 hover:bg-sky-500/10 transition"
            >
              Excel todos
            </button>
          </div>
        </div>

        <div class="max-h-[480px] overflow-auto">
          <table class="min-w-full text-xs">
            <thead class="bg-slate-900/90 border-b border-slate-800 text-[11px] uppercase tracking-wide text-slate-400">
              <tr>
                <th class="px-3 py-2 text-center w-10">
                  <input
                    id="check-all-registros"
                    type="checkbox"
                    class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-950 text-emerald-500 focus:ring-emerald-500/60"
                    title="Selecionar todos visiveis"
                  />
                </th>
                <th class="px-3 py-2 text-left">Data</th>
                <th class="px-3 py-2 text-left">Animal</th>
                <th class="px-3 py-2 text-left">Nome cientifico</th>
                <th class="px-3 py-2 text-left">Biologo</th>
                <th class="px-3 py-2 text-left">Municipio</th>
                <th class="px-3 py-2 text-left">Colaborador</th>
                <th class="px-3 py-2 text-right">Acoes</th>
              </tr>
            </thead>
            <tbody id="tbody-registros" class="divide-y divide-slate-800">
              <!-- linhas via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Painel lateral: detalhes do registro selecionado -->
    <div class="lg:col-span-4">
      <div class="rounded-2xl bg-slate-950/85 border border-slate-800/80 backdrop-blur-xl p-4 h-full flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <div>
            <p class="text-xs font-semibold text-slate-100">Detalhes do registro</p>
            <p id="det-id" class="text-[11px] text-slate-500">Selecione um registro na tabela</p>
          </div>
          <button
            id="btn-ver-mapa"
            type="button"
            class="text-[11px] px-2 py-1 rounded-lg border border-slate-700 text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
            disabled
          >
            Ver no mapa
          </button>
        </div>

        <div class="flex-1 space-y-3 text-[11px] text-slate-300">
          <div>
            <p class="text-slate-500">Animal</p>
            <p id="det-animal" class="font-medium text-slate-100">-</p>
          </div>
          <div>
            <p class="text-slate-500">Nome cientifico</p>
            <p id="det-especie" class="font-medium text-slate-100 break-words">-</p>
          </div>
          <div>
            <p class="text-slate-500">Biologo responsavel</p>
            <p id="det-biologo" class="font-medium text-slate-100">-</p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <p class="text-slate-500">Municipio</p>
              <p id="det-municipio" class="font-medium text-slate-100">-</p>
            </div>
            <div>
              <p class="text-slate-500">Data</p>
              <p id="det-data" class="font-medium text-slate-100">-</p>
            </div>
          </div>
          <div>
            <p class="text-slate-500">Local de captura</p>
            <p id="det-local" class="font-medium text-slate-100 break-words">-</p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <p class="text-slate-500">Periodo</p>
              <p id="det-periodo" class="font-medium text-slate-100">-</p>
            </div>
            <div>
              <p class="text-slate-500">Estado de saude</p>
              <p id="det-saude" class="font-medium text-slate-100">-</p>
            </div>
          </div>
          <div>
            <p class="text-slate-500">Destino</p>
            <p id="det-destino" class="font-medium text-slate-100">-</p>
          </div>
          <div>
            <p class="text-slate-500">Observacoes</p>
            <p id="det-observacoes" class="font-medium text-slate-100 break-words">-</p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <p class="text-slate-500">Latitude</p>
              <p id="det-lat" class="font-mono text-xs text-emerald-300">-</p>
            </div>
            <div>
              <p class="text-slate-500">Longitude</p>
              <p id="det-lon" class="font-mono text-xs text-emerald-300">-</p>
            </div>
          </div>
          <div>
            <p class="text-slate-500">Status</p>
            <span id="det-status" class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-slate-800 text-slate-200">
              -
            </span>
          </div>
        </div>

        <div class="pt-4 border-t border-slate-800 mt-4 space-y-3">
          <div class="flex items-center justify-between">
            <p class="text-[11px] uppercase tracking-wider text-slate-500">Fotos do registro</p>
            <span id="det-fotos-count" class="text-[10px] text-slate-600">0 foto(s)</span>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <p class="text-[11px] text-slate-500">Animal</p>
              <div class="foto-ratio relative w-full rounded-lg border border-slate-800 bg-slate-900/60 overflow-hidden">
                <img id="foto-animal" alt="Foto do animal" class="h-full w-full object-cover hidden" loading="lazy" />
                <div id="foto-animal-placeholder" class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-500">
                  Sem foto
                </div>
              </div>
            </div>

            <div class="space-y-1">
              <p class="text-[11px] text-slate-500">Local</p>
              <div class="foto-ratio relative w-full rounded-lg border border-slate-800 bg-slate-900/60 overflow-hidden">
                <img id="foto-local" alt="Foto do local" class="h-full w-full object-cover hidden" loading="lazy" />
                <div id="foto-local-placeholder" class="absolute inset-0 flex items-center justify-center text-[10px] text-slate-500">
                  Sem foto
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modal-edicao" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur-sm">
  <div class="w-full max-w-3xl mx-4 bg-slate-950 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl">
    <div class="px-4 py-3 flex items-center justify-between border-b border-slate-800">
      <div>
        <p class="text-sm font-semibold text-slate-100">Editar registro de fauna</p>
        <p class="text-[11px] text-slate-400">Atualize as informacoes do registro.</p>
      </div>
      <button
        id="btn-fechar-edicao"
        type="button"
        class="px-2.5 py-1.5 rounded-lg border border-slate-700 text-[11px] text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
      >
        Fechar
      </button>
    </div>

    <form id="form-edicao" class="px-4 py-4 space-y-3">
      <input type="hidden" id="edit-id" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="space-y-1">
          <label for="edit-animal" class="text-[11px] text-slate-400">Animal</label>
          <input
            id="edit-animal"
            type="text"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          />
        </div>
        <div class="space-y-1">
          <label for="edit-data" class="text-[11px] text-slate-400">Data de captura</label>
          <input
            id="edit-data"
            type="date"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          />
        </div>
      </div>

      <div class="space-y-1">
        <label for="edit-especie" class="text-[11px] text-slate-400">Nome cientifico</label>
        <input
          id="edit-especie"
          type="text"
          class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        />
      </div>

      <div class="space-y-1">
        <label for="edit-biologo" class="text-[11px] text-slate-400">Biologo responsavel</label>
        <input
          id="edit-biologo"
          type="text"
          class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="space-y-1">
          <label for="edit-municipio" class="text-[11px] text-slate-400">Municipio</label>
          <input
            id="edit-municipio"
            type="text"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          />
        </div>
        <div class="space-y-1">
          <label for="edit-local" class="text-[11px] text-slate-400">Local de captura</label>
          <input
            id="edit-local"
            type="text"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="space-y-1">
          <label for="edit-periodo" class="text-[11px] text-slate-400">Periodo</label>
          <select
            id="edit-periodo"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          >
            <option value="">-</option>
            <option value="Manha">Manha</option>
            <option value="Tarde">Tarde</option>
          </select>
        </div>
        <div class="space-y-1">
          <label for="edit-saude" class="text-[11px] text-slate-400">Estado de saude</label>
          <select
            id="edit-saude"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          >
            <option value="">-</option>
            <option value="Sao">Sadio</option>
            <option value="Ferido">Ferido</option>
          </select>
        </div>
        <div class="space-y-1">
          <label for="edit-destino" class="text-[11px] text-slate-400">Destino</label>
          <select
            id="edit-destino"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          >
            <option value="">-</option>
            <option value="Soltura">Soltura</option>
            <option value="Centro de triagem">Centro de triagem</option>
            <option value="Obito">Obito</option>
          </select>
        </div>
      </div>

      <div class="space-y-1">
        <label for="edit-observacoes" class="text-[11px] text-slate-400">Observacoes</label>
        <textarea
          id="edit-observacoes"
          rows="3"
          class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                 outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
        ></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="space-y-1">
          <label for="edit-lat" class="text-[11px] text-slate-400">Latitude</label>
          <input
            id="edit-lat"
            type="number"
            step="0.000001"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          />
        </div>
        <div class="space-y-1">
          <label for="edit-lon" class="text-[11px] text-slate-400">Longitude</label>
          <input
            id="edit-lon"
            type="number"
            step="0.000001"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          />
        </div>
        <div class="space-y-1">
          <label for="edit-status" class="text-[11px] text-slate-400">Status</label>
          <select
            id="edit-status"
            class="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg px-2 py-1.5
                   outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-500/40"
          >
            <option value="">-</option>
            <option value="SINCRONIZADO">Sincronizado</option>
            <option value="PENDENTE">Pendente</option>
            <option value="VALIDADO">Validado</option>
          </select>
        </div>
      </div>

      <p id="edit-error" class="hidden text-[11px] text-rose-400 bg-rose-500/10 border border-rose-500/40 rounded-lg px-3 py-2">
        Erro ao salvar as alteracoes.
      </p>

      <div class="pt-2 flex justify-end gap-2">
        <button
          type="button"
          id="btn-cancelar-edicao"
          class="px-3 py-2 text-xs rounded-lg border border-slate-700 text-slate-300 hover:bg-slate-900/80"
        >
          Cancelar
        </button>
        <button
          type="submit"
          id="btn-salvar-edicao"
          class="px-4 py-2 text-xs rounded-lg bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400 hover:shadow-[0_0_20px_rgba(16,185,129,0.5)] transition-all"
        >
          Salvar
        </button>
      </div>
    </form>
  </div>
</div>

<div id="mapa-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/80 backdrop-blur-sm">
  <div class="w-full max-w-3xl mx-4 bg-slate-950 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl">
    <div class="px-4 py-3 flex items-center justify-between border-b border-slate-800">
      <div>
        <p class="text-sm font-semibold text-slate-100">Mapa do registro</p>
        <p id="mapa-coords" class="text-[11px] text-slate-400">-</p>
      </div>
      <button
        id="btn-fechar-mapa"
        type="button"
        class="px-2.5 py-1.5 rounded-lg border border-slate-700 text-[11px] text-slate-300 hover:border-emerald-400 hover:text-emerald-300 transition"
      >
        Fechar
      </button>
    </div>
    <div id="mapa-fauna" class="bg-slate-900"></div>
    <div class="px-4 py-2 border-t border-slate-800 text-[11px] text-slate-500">
      Clique e arraste para navegar. Scroll para zoom.
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const tbody = document.getElementById("tbody-registros");
  const infoTotal = document.getElementById("info-total");
  const buscaTexto = document.getElementById("busca-texto");
  const filtroDataInicio = document.getElementById("filtro-data-inicio");
  const filtroDataFim = document.getElementById("filtro-data-fim");
  const filtroMunicipio = document.getElementById("filtro-municipio");
  const btnAplicar = document.getElementById("btn-aplicar-filtros");
  const btnLimpar = document.getElementById("btn-limpar-filtros");
  const infoSelecao = document.getElementById("info-selecao");
  const checkAllRegistros = document.getElementById("check-all-registros");
  const btnExportarPdf = document.getElementById("btn-exportar-pdf");
  const btnExportarExcelSelecionados = document.getElementById("btn-exportar-excel-selecionados");
  const btnExportarExcelTodos = document.getElementById("btn-exportar-excel-todos");

  const detId = document.getElementById("det-id");
  const detAnimal = document.getElementById("det-animal");
  const detEspecie = document.getElementById("det-especie");
  const detBiologo = document.getElementById("det-biologo");
  const detMunicipio = document.getElementById("det-municipio");
  const detLocal = document.getElementById("det-local");
  const detPeriodo = document.getElementById("det-periodo");
  const detSaude = document.getElementById("det-saude");
  const detDestino = document.getElementById("det-destino");
  const detObservacoes = document.getElementById("det-observacoes");
  const detData = document.getElementById("det-data");
  const detLat = document.getElementById("det-lat");
  const detLon = document.getElementById("det-lon");
  const detStatus = document.getElementById("det-status");
  const btnVerMapa = document.getElementById("btn-ver-mapa");
  const mapaModal = document.getElementById("mapa-modal");
  const btnFecharMapa = document.getElementById("btn-fechar-mapa");
  const mapaCoords = document.getElementById("mapa-coords");
  const detFotosCount = document.getElementById("det-fotos-count");
  const fotoAnimal = document.getElementById("foto-animal");
  const fotoLocal = document.getElementById("foto-local");
  const fotoAnimalPlaceholder = document.getElementById("foto-animal-placeholder");
  const fotoLocalPlaceholder = document.getElementById("foto-local-placeholder");
  const modalEdicao = document.getElementById("modal-edicao");
  const btnFecharEdicao = document.getElementById("btn-fechar-edicao");
  const btnCancelarEdicao = document.getElementById("btn-cancelar-edicao");
  const formEdicao = document.getElementById("form-edicao");
  const editId = document.getElementById("edit-id");
  const editAnimal = document.getElementById("edit-animal");
  const editData = document.getElementById("edit-data");
  const editEspecie = document.getElementById("edit-especie");
  const editBiologo = document.getElementById("edit-biologo");
  const editMunicipio = document.getElementById("edit-municipio");
  const editLocal = document.getElementById("edit-local");
  const editPeriodo = document.getElementById("edit-periodo");
  const editSaude = document.getElementById("edit-saude");
  const editDestino = document.getElementById("edit-destino");
  const editObservacoes = document.getElementById("edit-observacoes");
  const editLat = document.getElementById("edit-lat");
  const editLon = document.getElementById("edit-lon");
  const editStatus = document.getElementById("edit-status");
  const editError = document.getElementById("edit-error");

  let mapa = null;
  let mapaMarker = null;

  let registros = [];
  let registrosFiltrados = [];
  const registrosSelecionados = new Set();
  let registroSelecionado = null;
  const detIdDefault = detId.textContent;

  function formatarData(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleDateString("pt-BR");
  }

  function formatarDataInput(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getUTCFullYear()}-${pad(d.getUTCMonth() + 1)}-${pad(d.getUTCDate())}`;
  }

  function toIsoFromDateInput(value) {
    if (!value) return null;
    const d = new Date(`${value}T00:00:00Z`);
    if (Number.isNaN(d.getTime())) return null;
    return d.toISOString();
  }

  function parseOptionalFloat(value) {
    const raw = String(value ?? "").trim();
    if (!raw) return null;
    const num = Number(raw.replace(",", "."));
    return Number.isFinite(num) ? num : null;
  }

  function normalizarFotoPath(valor) {
    if (valor == null) return null;
    let v = String(valor).trim();
    if (!v || v === "-" || v.toLowerCase() === "null") return null;

    if (/^data:image\//i.test(v)) return v;
    if (/^https?:\/\//i.test(v)) return v;

    if (/^[A-Za-z0-9+/=]+$/.test(v) && v.length > 200) {
      return `data:image/png;base64,${v}`;
    }

    v = v.replace(/\\/g, "/");
    const lower = v.toLowerCase();
    const mediaIndex = lower.lastIndexOf("/media/");
    if (mediaIndex >= 0) return v.slice(mediaIndex);

    if (v.startsWith("/")) return v;
    if (lower.startsWith("media/")) return `/${v}`;
    if (lower.startsWith("fauna/")) return `/media/${v}`;
    return `/media/${v}`;
  }

  function atualizarFoto(imgEl, placeholderEl, url) {
    if (url) {
      imgEl.src = url;
      imgEl.classList.remove("hidden");
      placeholderEl.classList.add("hidden");
    } else {
      imgEl.removeAttribute("src");
      imgEl.classList.add("hidden");
      placeholderEl.classList.remove("hidden");
    }
  }

  function atualizarFotos(r) {
    if (!r) {
      atualizarFoto(fotoAnimal, fotoAnimalPlaceholder, null);
      atualizarFoto(fotoLocal, fotoLocalPlaceholder, null);
      detFotosCount.textContent = "0 foto(s)";
      return;
    }

    const animalUrl = normalizarFotoPath(r.foto_animal_path);
    const localUrl = normalizarFotoPath(r.foto_local_path);

    atualizarFoto(fotoAnimal, fotoAnimalPlaceholder, animalUrl);
    atualizarFoto(fotoLocal, fotoLocalPlaceholder, localUrl);

    const total = [animalUrl, localUrl].filter(Boolean).length;
    detFotosCount.textContent = `${total} foto(s)`;
  }

  [
    [fotoAnimal, fotoAnimalPlaceholder],
    [fotoLocal, fotoLocalPlaceholder]
  ].forEach(([imgEl, placeholderEl]) => {
    imgEl.addEventListener("error", () => {
      imgEl.classList.add("hidden");
      placeholderEl.classList.remove("hidden");
    });
  });

  function normalizarId(id) {
    if (id == null) return "";
    return String(id).trim();
  }

  function getIdsSelecionados() {
    return Array.from(registrosSelecionados)
      .map((id) => Number(id))
      .filter((id) => Number.isInteger(id));
  }

  function montarUrlExportacao(path, ids) {
    const url = new URL(path, window.location.origin);
    if (ids && ids.length) {
      url.searchParams.set("ids", ids.join(","));
    }
    return url.toString();
  }

  function iniciarDownload(url) {
    const link = document.createElement("a");
    link.href = url;
    document.body.appendChild(link);
    link.click();
    link.remove();
  }

  function atualizarEstadoSelecao() {
    const totalSelecionados = registrosSelecionados.size;
    const idsVisiveis = registrosFiltrados
      .map((item) => normalizarId(item.id))
      .filter(Boolean);
    const totalVisiveis = idsVisiveis.length;
    const selecionadosVisiveis = idsVisiveis.filter((id) => registrosSelecionados.has(id)).length;

    infoSelecao.textContent = `${totalSelecionados} selecionado(s)`;
    checkAllRegistros.disabled = totalVisiveis === 0;
    checkAllRegistros.checked = totalVisiveis > 0 && selecionadosVisiveis === totalVisiveis;
    checkAllRegistros.indeterminate =
      selecionadosVisiveis > 0 && selecionadosVisiveis < totalVisiveis;

    const hasRegistroDetalhe = Boolean(registroSelecionado && registroSelecionado.id != null);
    btnExportarPdf.disabled = !totalSelecionados && !hasRegistroDetalhe;
    btnExportarExcelSelecionados.disabled = !totalSelecionados;
  }

  function selecionarTodosVisiveis(selecionar) {
    const idsVisiveis = registrosFiltrados
      .map((item) => normalizarId(item.id))
      .filter(Boolean);

    for (const id of idsVisiveis) {
      if (selecionar) {
        registrosSelecionados.add(id);
      } else {
        registrosSelecionados.delete(id);
      }
    }

    renderTabela(registrosFiltrados);
  }

  function exportarPdfSelecionados() {
    const ids = getIdsSelecionados();

    if (!ids.length && registroSelecionado && registroSelecionado.id != null) {
      ids.push(Number(registroSelecionado.id));
    }

    if (!ids.length) {
      alert("Selecione ao menos um registro para exportar PDF.");
      return;
    }

    const url = montarUrlExportacao("/api/registros-fauna/admin/export/pdf", ids);
    iniciarDownload(url);
  }

  function exportarPdfUnico(id) {
    const parsed = Number(id);
    if (!Number.isInteger(parsed)) return;
    const url = montarUrlExportacao("/api/registros-fauna/admin/export/pdf", [parsed]);
    iniciarDownload(url);
  }

  function exportarExcelSelecionados() {
    const ids = getIdsSelecionados();
    if (!ids.length) {
      alert("Selecione ao menos um registro para exportar Excel.");
      return;
    }

    const url = montarUrlExportacao("/api/registros-fauna/admin/export/excel", ids);
    iniciarDownload(url);
  }

  function exportarExcelTodos() {
    const url = montarUrlExportacao("/api/registros-fauna/admin/export/excel");
    iniciarDownload(url);
  }

  function aplicarFiltrosLocal() {
    const termo = buscaTexto.value.toLowerCase();
    const muni = filtroMunicipio.value;
    const dataIni = filtroDataInicio.value ? new Date(filtroDataInicio.value) : null;
    const dataFim = filtroDataFim.value ? new Date(filtroDataFim.value) : null;

    registrosFiltrados = registros.filter((r) => {
      const textoAlvo = [
        r.nome_cientifico || "",
        r.municipio || "",
        r.biologo_responsavel || "",
        r.colaborador_nome || "",
        r.animal_number || "",
        r.id_dispositivo || ""
      ].join(" ").toLowerCase();

      if (termo && !textoAlvo.includes(termo)) return false;
      if (muni && r.municipio !== muni) return false;

      if (dataIni || dataFim) {
        const d = r.data_captura ? new Date(r.data_captura) : null;
        if (d && dataIni && d < dataIni) return false;
        if (d && dataFim && d > dataFim) return false;
      }

      return true;
    });

    renderTabela(registrosFiltrados);
  }

  function renderTabela(lista) {
    tbody.innerHTML = "";

    if (!lista.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="px-3 py-4 text-center text-[11px] text-slate-500">
            Nenhum registro encontrado com os filtros atuais.
          </td>
        </tr>
      `;
    } else {
      for (const r of lista) {
        const idNormalizado = normalizarId(r.id);
        const marcado = idNormalizado && registrosSelecionados.has(idNormalizado);
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-900/70 transition cursor-pointer";
        tr.dataset.id = r.id ?? "";

        tr.innerHTML = `
          <td class="px-3 py-2 align-middle text-center">
            <input
              type="checkbox"
              class="checkbox-registro h-3.5 w-3.5 rounded border-slate-600 bg-slate-950 text-emerald-500 focus:ring-emerald-500/60"
              data-id="${r.id}"
              ${marcado ? "checked" : ""}
            />
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-300">
            ${formatarData(r.data_captura)}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.animal_number || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-100">
            ${r.nome_cientifico || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.biologo_responsavel || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.municipio || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-[11px] text-slate-200">
            ${r.colaborador_nome || "-"}
          </td>
          <td class="px-3 py-2 align-middle text-right text-[11px]">
            <div class="inline-flex items-center gap-1">
              <button
                class="px-2 py-1 rounded-lg border border-slate-700 text-slate-200 hover:border-emerald-400 hover:text-emerald-300 transition"
                data-action="details"
                data-id="${r.id}"
              >
                Detalhes
              </button>
              <button
                class="px-2 py-1 rounded-lg border border-slate-700 text-slate-200 hover:border-amber-400 hover:text-amber-300 transition"
                data-action="edit"
                data-id="${r.id}"
              >
                Editar
              </button>
              <button
                class="px-2 py-1 rounded-lg border border-sky-500/60 text-sky-300 hover:bg-sky-500/10 transition"
                data-action="pdf"
                data-id="${r.id}"
              >
                PDF
              </button>
              <button
                class="px-2 py-1 rounded-lg border border-rose-500/60 text-rose-300 hover:bg-rose-500/10 transition"
                data-action="delete"
                data-id="${r.id}"
              >
                Excluir
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      }
    }

    infoTotal.textContent = `${lista.length} registro(s) listado(s)`;
    atualizarEstadoSelecao();
  }

  function selecionarRegistro(r) {
    registroSelecionado = r;
    if (!r) {
      detId.textContent = detIdDefault;
      detAnimal.textContent = "-";
      detEspecie.textContent = "-";
      detBiologo.textContent = "-";
      detMunicipio.textContent = "-";
      detLocal.textContent = "-";
      detPeriodo.textContent = "-";
      detSaude.textContent = "-";
      detDestino.textContent = "-";
      detObservacoes.textContent = "-";
      detData.textContent = "-";
      detLat.textContent = "-";
      detLon.textContent = "-";
      detStatus.textContent = "-";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-slate-800 text-slate-200";
      btnVerMapa.disabled = true;
      btnVerMapa.title = "Sem coordenadas para este registro";
      atualizarFotos(null);
      atualizarEstadoSelecao();
      return;
    }
    detId.textContent = `ID: ${r.id ?? "-"} (Disp: ${r.id_dispositivo || "-"})`;
    detAnimal.textContent = r.animal_number || "-";
    detEspecie.textContent = r.nome_cientifico || "-";
    detBiologo.textContent = r.biologo_responsavel || "-";
    detMunicipio.textContent = r.municipio || "-";
    detLocal.textContent = r.local_captura || "-";
    detPeriodo.textContent = r.periodo_resgate || "-";
    detSaude.textContent = r.estado_saude || "-";
    detDestino.textContent = r.destino || "-";
    detObservacoes.textContent = r.observacoes || "-";
    detData.textContent = formatarData(r.data_captura);
    detLat.textContent = r.latitude != null ? Number(r.latitude).toFixed(6) : "-";
    detLon.textContent = r.longitude != null ? Number(r.longitude).toFixed(6) : "-";

    const hasCoords =
      r.latitude != null &&
      r.longitude != null &&
      !Number.isNaN(Number(r.latitude)) &&
      !Number.isNaN(Number(r.longitude));
    btnVerMapa.disabled = !hasCoords;

    if (r.status === "VALIDADO") {
      detStatus.textContent = "Validado";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-emerald-500/15 border border-emerald-500/40 text-emerald-300";
    } else if (r.status === "PENDENTE") {
      detStatus.textContent = "Pendente";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-amber-500/10 border border-amber-500/40 text-amber-300";
    } else if (r.status) {
      detStatus.textContent = r.status;
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-slate-800 text-slate-200";
    } else {
      detStatus.textContent = "-";
      detStatus.className = "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] bg-slate-800 text-slate-200";
    }

    if (!hasCoords) {
      btnVerMapa.title = "Sem coordenadas para este registro";
    } else {
      btnVerMapa.title = "";
    }

    atualizarFotos(r);
    atualizarEstadoSelecao();
  }

  function abrirModalEdicao(r) {
    if (!r) return;
    editError.classList.add("hidden");
    editId.value = r.id ?? "";
    editAnimal.value = r.animal_number || "";
    editData.value = formatarDataInput(r.data_captura);
    editEspecie.value = r.nome_cientifico || "";
    editBiologo.value = r.biologo_responsavel || "";
    editMunicipio.value = r.municipio || "";
    editLocal.value = r.local_captura || "";
    editPeriodo.value = r.periodo_resgate || "";
    editSaude.value = r.estado_saude || "";
    editDestino.value = r.destino || "";
    editObservacoes.value = r.observacoes || "";
    editLat.value = r.latitude != null ? String(r.latitude) : "";
    editLon.value = r.longitude != null ? String(r.longitude) : "";
    editStatus.value = r.status || "";

    modalEdicao.classList.remove("hidden");
    modalEdicao.classList.add("flex");
  }

  function fecharModalEdicao() {
    modalEdicao.classList.add("hidden");
    modalEdicao.classList.remove("flex");
  }

  function atualizarRegistroNaLista(atualizado) {
    if (!atualizado || atualizado.id == null) return null;
    const idx = registros.findIndex((item) => item.id == atualizado.id);
    if (idx >= 0) {
      registros[idx] = { ...registros[idx], ...atualizado };
      return registros[idx];
    }
    registros.push(atualizado);
    return atualizado;
  }

  async function salvarEdicao(ev) {
    ev.preventDefault();
    editError.classList.add("hidden");

    const id = editId.value;
    if (!id) return;

    const payload = {
      animal_number: editAnimal.value.trim() || null,
      nome_cientifico: editEspecie.value.trim() || null,
      data_captura: toIsoFromDateInput(editData.value),
      biologo_responsavel: editBiologo.value.trim() || null,
      municipio: editMunicipio.value.trim() || null,
      local_captura: editLocal.value.trim() || null,
      periodo_resgate: editPeriodo.value || null,
      estado_saude: editSaude.value || null,
      destino: editDestino.value || null,
      observacoes: editObservacoes.value.trim() || null,
      latitude: parseOptionalFloat(editLat.value),
      longitude: parseOptionalFloat(editLon.value),
      status: editStatus.value || null,
    };

    try {
      const res = await fetch(`/api/registros-fauna/admin/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        let errorText = "Erro ao salvar as alteracoes.";
        try {
          const err = await res.json();
          if (typeof err.detail === "string") {
            errorText = err.detail;
          }
        } catch (_) {
          // Mantem mensagem padrao.
        }
        editError.textContent = errorText;
        editError.classList.remove("hidden");
        return;
      }

      const atualizado = await res.json();
      const item = atualizarRegistroNaLista(atualizado);
      aplicarFiltrosLocal();
      selecionarRegistro(item || atualizado);
      fecharModalEdicao();
    } catch (err) {
      console.error(err);
      editError.textContent = "Erro ao salvar as alteracoes.";
      editError.classList.remove("hidden");
    }
  }

  async function excluirRegistro(id, registro) {
    const label = registro?.animal_number || registro?.id || id;
    if (!confirm(`Excluir o registro "${label}"?`)) return;
    try {
      const res = await fetch(`/api/registros-fauna/admin/${id}`, { method: "DELETE" });
      if (!res.ok) throw new Error("Erro ao excluir");
      registros = registros.filter((item) => item.id != id);
      registrosSelecionados.delete(normalizarId(id));
      if (registroSelecionado && registroSelecionado.id == id) {
        selecionarRegistro(null);
      }
      aplicarFiltrosLocal();
    } catch (err) {
      console.error(err);
      alert("Erro ao excluir registro.");
    }
  }

  function abrirMapa() {
    if (!registroSelecionado) return;
    const lat = Number(registroSelecionado.latitude);
    const lon = Number(registroSelecionado.longitude);
    if (Number.isNaN(lat) || Number.isNaN(lon)) return;

    mapaCoords.textContent = `Lat ${lat.toFixed(6)}, Lon ${lon.toFixed(6)}`;
    mapaModal.classList.remove("hidden");
    mapaModal.classList.add("flex");

    if (!mapa) {
      mapa = L.map("mapa-fauna", { zoomControl: true }).setView([lat, lon], 15);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        attribution: "&copy; OpenStreetMap &copy; CARTO",
        subdomains: "abcd",
        maxZoom: 20
      }).addTo(mapa);
    } else {
      mapa.setView([lat, lon], 15);
    }

    if (mapaMarker) {
      mapaMarker.setLatLng([lat, lon]);
    } else {
      mapaMarker = L.marker([lat, lon]).addTo(mapa);
    }

    setTimeout(() => mapa.invalidateSize(), 120);
  }

  function fecharMapa() {
    mapaModal.classList.add("hidden");
    mapaModal.classList.remove("flex");
  }

  async function carregarRegistros() {
    infoTotal.textContent = "Carregando registros...";
    try {
      const res = await fetch("/api/registros-fauna/admin");
      if (!res.ok) throw new Error("Erro ao carregar");
      registros = await res.json();
      const idsAtuais = new Set(registros.map((item) => normalizarId(item.id)).filter(Boolean));
      for (const id of Array.from(registrosSelecionados)) {
        if (!idsAtuais.has(id)) {
          registrosSelecionados.delete(id);
        }
      }
      aplicarFiltrosLocal();
    } catch (err) {
      console.error(err);
      infoTotal.textContent = "Erro ao carregar registros.";
      registrosFiltrados = [];
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="px-3 py-4 text-center text-[11px] text-rose-400">
            Erro ao carregar registros do servidor.
          </td>
        </tr>
      `;
      atualizarEstadoSelecao();
    }
  }

  buscaTexto.addEventListener("input", aplicarFiltrosLocal);
  btnAplicar.addEventListener("click", aplicarFiltrosLocal);
  btnLimpar.addEventListener("click", () => {
    filtroDataInicio.value = "";
    filtroDataFim.value = "";
    filtroMunicipio.value = "";
    buscaTexto.value = "";
    aplicarFiltrosLocal();
  });

  checkAllRegistros.addEventListener("change", () => {
    selecionarTodosVisiveis(checkAllRegistros.checked);
  });

  btnExportarPdf.addEventListener("click", exportarPdfSelecionados);
  btnExportarExcelSelecionados.addEventListener("click", exportarExcelSelecionados);
  btnExportarExcelTodos.addEventListener("click", exportarExcelTodos);

  tbody.addEventListener("change", (ev) => {
    const checkbox = ev.target.closest(".checkbox-registro");
    if (!checkbox) return;

    const id = normalizarId(checkbox.getAttribute("data-id"));
    if (!id) return;

    if (checkbox.checked) {
      registrosSelecionados.add(id);
    } else {
      registrosSelecionados.delete(id);
    }

    atualizarEstadoSelecao();
  });

  tbody.addEventListener("click", (ev) => {
    if (ev.target.closest(".checkbox-registro")) return;

    const btn = ev.target.closest("button");
    if (btn) {
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action") || "details";
      const registro = registros.find((item) => item.id == id);
      if (!registro) return;

      if (action === "edit") {
        selecionarRegistro(registro);
        abrirModalEdicao(registro);
      } else if (action === "pdf") {
        exportarPdfUnico(id);
      } else if (action === "delete") {
        excluirRegistro(id, registro);
      } else {
        selecionarRegistro(registro);
      }
      return;
    }

    const row = ev.target.closest("tr");
    if (!row) return;
    const id = row.dataset.id;
    const registro = registros.find((item) => item.id == id);
    if (registro) selecionarRegistro(registro);
  });

  formEdicao.addEventListener("submit", salvarEdicao);
  btnFecharEdicao.addEventListener("click", fecharModalEdicao);
  btnCancelarEdicao.addEventListener("click", fecharModalEdicao);
  modalEdicao.addEventListener("click", (ev) => {
    if (ev.target === modalEdicao) fecharModalEdicao();
  });

  btnVerMapa.addEventListener("click", abrirMapa);
  btnFecharMapa.addEventListener("click", fecharMapa);
  mapaModal.addEventListener("click", (ev) => {
    if (ev.target === mapaModal) fecharMapa();
  });

  atualizarFotos(null);
  atualizarEstadoSelecao();
  carregarRegistros();
</script>
{% endblock %}
